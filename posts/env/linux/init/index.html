<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Linux åˆå§‹åŒ– | ä»è¿Ÿ</title>
<meta name=keywords content="ç¯å¢ƒ,linux"><meta name=description content="æµ‹è¯•æœåŠ¡å™¨ç¯å¢ƒï¼šHuawei Cloud EulerOS 2.0"><meta name=author content="ä»è¿Ÿ"><link rel=canonical href=https://rengchi.github.io/posts/env/linux/init/><link crossorigin=anonymous href=/assets/css/stylesheet.45e028aa8ce0961349adf411b013ee39406be2c0bc80d4ea3fc04555f7f4611a.css integrity="sha256-ReAoqozglhNJrfQRsBPuOUBr4sC8gNTqP8BFVff0YRo=" rel="preload stylesheet" as=style><link rel=icon href=https://rengchi.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://rengchi.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://rengchi.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://rengchi.github.io/apple-touch-icon.png><link rel=mask-icon href=https://rengchi.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://rengchi.github.io/posts/env/linux/init/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://rengchi.github.io/posts/env/linux/init/"><meta property="og:site_name" content="ä»è¿Ÿ"><meta property="og:title" content="Linux åˆå§‹åŒ–"><meta property="og:description" content="æµ‹è¯•æœåŠ¡å™¨ç¯å¢ƒï¼šHuawei Cloud EulerOS 2.0"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-01-19T00:00:00+00:00"><meta property="article:modified_time" content="2025-01-19T00:00:00+00:00"><meta property="article:tag" content="ç¯å¢ƒ"><meta property="article:tag" content="Linux"><meta name=twitter:card content="summary"><meta name=twitter:title content="Linux åˆå§‹åŒ–"><meta name=twitter:description content="æµ‹è¯•æœåŠ¡å™¨ç¯å¢ƒï¼šHuawei Cloud EulerOS 2.0"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"ğŸ“æ–‡ç« ","item":"https://rengchi.github.io/posts/"},{"@type":"ListItem","position":2,"name":"ğŸŒç¯å¢ƒ","item":"https://rengchi.github.io/posts/env/"},{"@type":"ListItem","position":3,"name":"Linux åˆå§‹åŒ–","item":"https://rengchi.github.io/posts/env/linux/init/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Linux åˆå§‹åŒ–","name":"Linux åˆå§‹åŒ–","description":"æµ‹è¯•æœåŠ¡å™¨ç¯å¢ƒï¼šHuawei Cloud EulerOS 2.0","keywords":["ç¯å¢ƒ","linux"],"articleBody":"å†™åœ¨å‰é¢ å½“ç„¶ï¼Œå¦‚æœä½ ä½¿ç”¨ docker å®å¡” ç­‰æ­å»ºï¼Œå°±ä¸éœ€è¿™ä¹ˆéº»çƒ¦çš„ç¼–è¯‘å®‰è£…äº†ï¼Œå¯ä»¥å¿½ç•¥\nå‡†å¤‡ 2222 æ˜¯ ssh æ–°çš„è‡ªå®šä¹‰ç«¯å£ï¼Œä½¿ç”¨äº† sed -i è¡Œæ•°éƒ¨åˆ†è¯·å…ˆæŸ¥çœ‹\n#!/bin/bash # cls å‘½ä»¤æ·»åŠ  ln -s /usr/bin/clear /usr/local/bin/cls # é˜²ç«å¢™ systemctl start firewalld.service firewall-cmd --zone=public --add-port=80/tcp --permanent firewall-cmd --zone=public --add-port=443/tcp --permanent firewall-cmd --zone=public --add-port=2222/tcp --permanent # é‡å¯ systemctl restart firewalld # å¼€æœºå¯åŠ¨ systemctl enable firewalld.service # åˆ—è¡¨æŸ¥çœ‹ # firewall-cmd --list-ports # ssh cd /etc/ssh cp sshd_config sshd_config.bak sed -i '21s/#Port 22/Port 2222/' sshd_config cd /etc # ä¸»æœºåç§° cp hostname hostname.bak echo \"Rengchi\" \u003e hostname cd /etc/ cp sysctl.conf sysctl.conf.bak sed -i '$a vm.overcommit_memory = 1' /etc/sysctl.conf sudo sed -i '$a net.ipv4.tcp_max_syn_backlog = 4096' /etc/sysctl.conf sudo sed -i '$a net.ipv4.tcp_fin_timeout = 15' /etc/sysctl.conf sysctl -p reboot .vimrc vim ç›®å½• cd mkdir .vim .vim/backup .vim/undo \" è®©é…ç½®å˜æ›´ç«‹å³ç”Ÿæ•ˆ autocmd BufWritePost $MYVIMRC source $MYVIMRC \" åŸºç¡€è®¾ç½® set nocompatible \" ä¸å…¼å®¹ vi set noswapfile \" ä¸ç”Ÿæˆ swap æ–‡ä»¶ set autowrite \" è®¾ç½®è‡ªåŠ¨ä¿å­˜ set confirm \" æœªä¿å­˜æˆ–åªè¯»æ–‡ä»¶æ—¶å¼¹å‡ºç¡®è®¤æ¡† set number \" æ˜¾ç¤ºè¡Œå· set autoindent \" è‡ªåŠ¨ç¼©è¿› set smartindent \" æ™ºèƒ½ç¼©è¿› \" set mouse=a \" å¯ç”¨é¼ æ ‡æ”¯æŒ syntax on \" å¼€å¯è¯­æ³•é«˜äº® \" Tab å’Œç¼©è¿›è®¾ç½® set tabstop=4 \" è®¾ç½® Tab ä¸º 4 ä¸ªç©ºæ ¼ set shiftwidth=4 \" è®¾ç½®ç¼©è¿›å®½åº¦ä¸º 4 ä¸ªç©ºæ ¼ set softtabstop=4 \" è®¾ç½® Tab ä¸º 4 ä¸ªç©ºæ ¼ set expandtab \" ç”¨ç©ºæ ¼æ›¿ä»£ Tab \" ç¼–ç è®¾ç½® set fileencodings=utf-8,ucs-bom,gb18030,gbk,gb2312,cp936 set termencoding=utf-8 set encoding=utf-8 \" è‡ªåŠ¨åŠ è½½ set autoread \" æ–‡æœ¬æ˜¾ç¤ºè®¾ç½® set linebreak \" ä¸æ¢è¡Œæ–­å­— set showmatch \" é«˜äº®åŒ¹é…æ‹¬å· set cursorline \" çªå‡ºæ˜¾ç¤ºå½“å‰è¡Œ set ruler \" æ‰“å¼€çŠ¶æ€æ æ ‡å°º \" æœç´¢è®¾ç½® set hlsearch \" æœç´¢æ—¶é«˜äº®åŒ¹é…çš„è¯ set incsearch \" è¾¹è¾“å…¥è¾¹æœç´¢ set ignorecase \" æœç´¢æ—¶å¿½ç•¥å¤§å°å†™ set smartcase \" å½“æœç´¢åŒ…å«å¤§å†™å­—æ¯æ—¶ï¼Œæœç´¢åŒºåˆ†å¤§å°å†™ \" ä¸­æ–‡å¸®åŠ©è®¾ç½® set helplang=cn \" è®¾ç½®ä¸­æ–‡å¸®åŠ© set ambiwidth=double \" è®¾ç½®åŒå­—å®½æ˜¾ç¤ºï¼Œé˜²æ­¢å­—ç¬¦ä¸å®Œæ•´ \" å¤‡ä»½ä¸æ’¤é”€æ–‡ä»¶è®¾ç½® set backup \" å¼€å¯å¤‡ä»½æ–‡ä»¶ set backupdir=~/.vim/backup \" è®¾ç½®å¤‡ä»½æ–‡ä»¶å­˜æ”¾è·¯å¾„ set undofile \" å¼€å¯æ’¤é”€å†å²è®°å½•æ–‡ä»¶ set undodir=~/.vim/undo \" è®¾ç½®æ’¤é”€æ–‡ä»¶å­˜æ”¾è·¯å¾„ \" å¿«æ·é”®æ˜ å°„ let mapleader = \",\" \" å®šä¹‰ é”® nnoremap e :e ~/.vimrc \" å¿«é€Ÿæ‰“å¼€ vim é…ç½®æ–‡ä»¶ nnoremap r :source $MYVIMRC \" åˆ·æ–°é…ç½® nnoremap yyp \" Ctrl+d å¤åˆ¶æœ¬è¡Œå¹¶ç²˜è´´åˆ°ä¸‹ä¸€è¡Œ inoremap ;; \" å°† ESC é”®æ˜ å°„ä¸ºä¸¤æ¬¡ ; é”® nnoremap q :q \" +q å¿«é€Ÿé€€å‡º vim inoremap q :q nnoremap s :w \" +s å¿«é€Ÿä¿å­˜ inoremap s :w \" æ’å…¥æ¨¡å¼ã€æ­£å¸¸æ¨¡å¼æŒ‰ Ctrl+u å¿«é€Ÿè½¬æ¢ä¸ºå¤§å†™ inoremap viwUea nnoremap viwUe \" æ–‡ä»¶å¤´éƒ¨ç­¾åä¿¡æ¯ç®¡ç† nmap ms:call TitleDet() 's function AddTitle() call append (0,\"/*********************************************************************\") call append (1,\" * Author : ä»è¿Ÿ\") call append (2,\" * Create At : \".strftime(\"%Y-%m-%d %H:%M\")) call append (3,\" * Filename : \".expand(\"%:t\")) call append (4,\" * Description : çŸ¥ä¹‹è¡Œä¹‹ï¼Œæ— è´Ÿä»Šæ—¥\") call append (5,\" * ******************************************************************/\") echohl WarningMsg | echo \"æ·»åŠ æˆåŠŸ !!\" | echohl None endfunction function UpdateTitle() normal m' execute '/* Last modified\\s*:/s@:.*$@\\=strftime(\": %Y-%m-%d %H:%M\")@' normal '' normal mk execute '/* Filename\\s*:/s@:.*$@\\=\": \".expand(\"%:t\")@' execute \"noh\" normal 'k echohl WarningMsg | echo \"æ›´æ–°æˆåŠŸ !!\" | echohl None endfunction function TitleDet() let n=1 while n\u003c8 let line = getline(n) if line =~ '^\\s*\\*\\s*Last\\smodified\\s*:\\s*\\S*.*$' call UpdateTitle() return endif let n = n+1 endwhile call AddTitle() endfunction \" æŸ¥æ‰¾ä¸æ›¿æ¢ nnoremap / nnoremap :%s/ nnoremap sf :!grep -ri \" å…è®¸å…‰æ ‡é”®è·¨è¡Œï¼Œå…‰æ ‡å¯ä»¥å‡ºç°åœ¨æœ€åä¸€ä¸ªå­—ç¬¦å set whichwrap+=\u003c,\u003e,h,l set virtualedit=block,onemore ç¯å¢ƒå®‰è£…ç›®å½• /data ç›®å½•æœ‰å¯ä»¥ä½¿ç”¨é‡å¤ï¼Œéœ€è¦å…ˆæŸ¥çœ‹æ˜¯å¦å­˜åœ¨\n/fate ç›®å½•ä¸ºå­˜å‚¨é…ç½®æ–‡ä»¶ç›®å½•\ncd mkdir /env /logs /download /third /daemon /data /proj mkdir /logs/openresty /logs/openresty/proxy_temp /logs/redis /logs/mysql /fate mkdir /third/mysql mkdir /fate/openresty /fate/openresty/lua /fate/openresty/conf.d /fate/redis /fate/mysql mkdir /daemon/openresty /daemon/redis /daemon/mysql mkdir /data/mysql /data/mysql/data /data/mysql/mysql-files mkdir /proj/html /proj/go chmod 755 /env /fate /data /download /proj chmod -R 755 /logs/openresty /daemon /proj/html chmod 777 /logs goï¼ˆå¯é€‰ï¼‰ go é¡¹ç›®ç›´æ¥æŠŠæ‰“åŒ…åçš„æ”¾åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œå°±å¯ä»¥ï¼Œæˆ–è€…ä½¿ç”¨ docker\nå®‰è£… cd /download wget https://golang.google.cn/dl/go1.23.5.linux-amd64.tar.gz tar -zxf go1.23.5.linux-amd64.tar.gz mv /download/go /env/ rm -rf /download/go ln -s /env/go/bin/* /usr/local/bin/ go env -w GOPATH=/proj/go go env -w GOROOT=/env/go go env -w GOBIN=/proj/go/bin go env -w GOPROXY=https://goproxy.cn,direct go env -w GOCACHE=/logs/go/go-build go env -w GOMODCACHE=/logs/go/pkg/mod go env -w GO111MODULE=on å‘½ä»¤è‡ªåŠ¨è¡¥å…¨ ä¸­é€”éœ€è¦è¾“å…¥ä¸€ä¸ª y\ngo install github.com/posener/complete/gocomplete@latest /proj/go/bin/gocomplete -install ç¯å¢ƒå˜é‡ ln -s /proj/go/bin/* /usr/local/bin/ git å®‰è£… cd /download yum install zlib-devel -y wget https://www.kernel.org/pub/software/scm/git/git-2.48.1.tar.gz tar -zxf git-2.48.1.tar.gz cd git-2.48.1 ./configure --prefix=/env/git make -j$(nproc) make install ln -s /env/git/bin/* /usr/local/bin å‘½ä»¤è‡ªåŠ¨è¡¥å…¨ ï¼æ³¨ ./root/.bashrc\ncd wget https://raw.githubusercontent.com/git/git/master/contrib/completion/git-completion.bash mv /root/git-completion.bash /etc/bash_completion.d/ cat \u003e\u003e .bashrc \u003c\u003c EOF if [ -f /etc/bash_completion.d/git-completion.bash ]; then . /etc/bash_completion.d/git-completion.bash fi EOF . /root/.bashrc æ‰©å±• gitea ! æ­å»ºä¸­éœ€è¦ä½¿ç”¨ mysql openresty åä»£ï¼Œéœ€è¦åœ¨å®‰è£…å®Œæˆåæœ€åé…ç½®\ngithub gitea ä¸­æ–‡æ–‡æ¡£ ä¸‹è½½\n! è¯·åœ¨é˜…è¯»ç›¸å…³æ–‡æ¡£åå®‰è£…ï¼Œç†Ÿæ‚‰åå†å®‰è£…åˆ°ç”Ÿäº§ç¯å¢ƒ ç­¾åéªŒè¯\nuseradd -r -m -d /home/gitea -s /bin/bash gitea su gitea cd wget https://github.com/go-gitea/gitea/releases/download/v1.22.5/gitea-1.22.5-linux-amd64 wget https://github.com/go-gitea/gitea/releases/download/v1.22.5/gitea-1.22.5-linux-amd64.asc gpg --edit-key 7C9E68152594688862D62AF62D9AE806EC1592E2 gpg --keyserver hkp://pgp.mit.edu --recv 7C9E68152594688862D62AF62D9AE806EC1592E2 gpg --verify gitea-1.22.5-linux-amd64.asc gitea-1.22.5-linux-amd64 mv gitea-1.22.5-linux-amd64 gitea chmod +x /home/gitea/gitea ./gitea web --port 3000 systemctl enable gitea systemctl start gitea systemctl status gitea gitea.service vim /etc/systemd/system/gitea.service\n[Unit] Description=Gitea Documentation=https://docs.gitea.io After=network.target [Service] User=gitea Group=gitea ExecStart=/home/gitea/gitea web RestartSec=3 Restart=always Environment=GITEA_WORK_DIR=/home/gitea Environment=GITEA_CUSTOM=/home/gitea/custom WorkingDirectory=/home/gitea LimitNOFILE=4096 [Install] WantedBy=multi-user.target gitea.conf å¦‚æœå¼€å¯ https çš„è¯ï¼Œæ³¨æ„è¯ä¹¦é…ç½®é¡¹\n# gitea server { listen 80; server_name gitea.yourhost.com; return 301 https://$server_name$request_uri; } server { listen 443 ssl; server_name gitea.yourhost.com; # å¼ºåˆ¶æµè§ˆå™¨ä½¿ç”¨ HTTPS add_header Strict-Transport-Security \"max-age=31536000; includeSubDomains\" always; ssl_certificate /data/openresty/cert/gitea.yourhost.com/fullchain.pem; ssl_certificate_key /data/openresty/cert/gitea.yourhost.com/privkey.pem; ssl_protocols TLSv1.2 TLSv1.3; # ä»…æ”¯æŒ TLSv1.2 å’Œ TLSv1.3 ssl_ciphers 'TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:...'; # é€‰æ‹©å®‰å…¨çš„åŠ å¯†å¥—ä»¶ ssl_prefer_server_ciphers on; # å¼ºåˆ¶æœåŠ¡å™¨ä¼˜å…ˆé€‰æ‹©åŠ å¯†å¥—ä»¶ ssl_session_cache shared:SSL:1m; ssl_session_timeout 5m; access_log /logs/openresty/gitea.access.log; error_log /logs/openresty/gitea.error.log; location / { proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_set_header Host $http_host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header Range $http_range; proxy_set_header If-Range $http_if_range; proxy_redirect off; proxy_pass http://127.0.0.1:3000; } } openresty openresty å®˜ç½‘\nå®‰è£… æœåŠ¡å™¨ä¸èƒ½ç›´æ¥ä½¿ç”¨ yum å®‰è£…ï¼Œè¿™é‡Œé€‰æ‹©ä¸‹è½½ç¼–è¯‘å®‰è£…\nyum install pcre-devel zlib-devel openssl-devel geoip-devel jemalloc-devel -y cd /download wget https://mirrors.huaweicloud.com/openresty/v1.25.3.2/openresty-1.25.3.2.tar.gz tar -zxf openresty-1.25.3.2.tar.gz cd /download/openresty-1.25.3.2 ./configure --prefix=/env/openresty \\ --conf-path=/fate/openresty/nginx.conf \\ --error-log-path=/logs/openresty/error.log \\ --http-log-path=/logs/openresty/access.log \\ --pid-path=/daemon/openresty/openresty.pid \\ --with-http_v2_module \\ --with-http_realip_module \\ --with-http_stub_status_module \\ --with-luajit \\ --with-cc=gcc \\ --with-stream \\ --with-stream_ssl_module \\ --with-http_ssl_module \\ --with-http_sub_module \\ --with-http_secure_link_module \\ --with-http_gzip_static_module \\ --with-http_auth_request_module \\ --with-pcre-jit \\ --with-threads \\ --with-http_geoip_module \\ --with-poll_module \\ --with-ld-opt=\"-ljemalloc\" \\ --with-http_dav_module \\ --with-http_flv_module \\ --with-http_mp4_module \\ --with-http_slice_module \\ --with-file-aio gmake -j$(nproc) gmake install groupadd -r openresty useradd -r -g openresty -s /sbin/nologin openresty ln -s /env/openresty/bin/openresty /usr/local/bin/ chmod 755 /env/openresty chown -R openresty:openresty /env/openresty chmod 644 /env/openresty/lualib chown -R openresty:openresty /env/openresty/lualib/ chmod -R 644 /env/openresty/lualib/resty chown -R openresty:openresty /env/openresty/lualib/resty chmod -R 755 /proj/html chmod 755 /fate/openresty chown -R openresty:openresty /fate/openresty chmod -R 644 /fate/openresty/conf.d chown -R openresty:openresty /fate/openresty/conf.d å¼€æœºè‡ªåŠ¨å¯åŠ¨ openresty # chkconfig: - 60 80\nvim /etc/init.d/openresty chmod +x /etc/init.d/openresty chkconfig --add openresty chkconfig openresty on #!/bin/bash # chkconfig: - 60 80 # OpenResty æœåŠ¡åˆå§‹åŒ–è„šæœ¬ # ç”¨äºåœ¨ç³»ç»Ÿå¯åŠ¨æ—¶å¯åŠ¨ OpenRestyï¼ŒåŠåœ¨è¿è¡Œæ—¶è¿›è¡Œç®¡ç† nginxd=/env/openresty/nginx/sbin/nginx nginx_config=/fate/openresty/nginx.conf nginx_pid=/daemon/openresty/openresty.pid RETVAL=0 prog=\"OpenResty\" # å¯¼å…¥å‡½æ•°åº“ . /etc/rc.d/init.d/functions # å¯¼å…¥ç½‘ç»œé…ç½® . /etc/sysconfig/network # æ£€æŸ¥ç½‘ç»œæ˜¯å¦å¯åŠ¨ [ ${NETWORKING} = \"no\" ] \u0026\u0026 exit 0 # æ£€æŸ¥ nginx å¯æ‰§è¡Œæ–‡ä»¶æ˜¯å¦å­˜åœ¨ [ -x $nginxd ] || exit 0 # å¯åŠ¨ OpenResty æœåŠ¡ start() { if [ -e $nginx_pid ]; then echo \"$prog å·²ç»åœ¨è¿è¡Œ...\" exit 1 fi echo -n $\"å¯åŠ¨ $prog: \" daemon $nginxd -c ${nginx_config} RETVAL=$? echo [ $RETVAL = 0 ] \u0026\u0026 touch /daemon/openresty/openresty.lock return $RETVAL } # åœæ­¢ OpenResty æœåŠ¡ stop() { echo -n $\"åœæ­¢ $prog: \" killproc $nginxd RETVAL=$? echo [ $RETVAL = 0 ] \u0026\u0026 rm -f /daemon/openresty/openresty.lock $nginx_pid } # é‡æ–°åŠ è½½ OpenResty é…ç½® reload() { echo -n $\"é‡æ–°åŠ è½½ $prog: \" killproc $nginxd -HUP RETVAL=$? echo } # æ ¹æ®ä¼ å…¥çš„å‚æ•°æ‰§è¡Œç›¸åº”æ“ä½œ case \"$1\" in start) start ;; stop) stop ;; reload) reload ;; restart) stop start ;; status) status $nginxd RETVAL=$? ;; *) echo $\"ç”¨æ³•: $prog {start|stop|status|restart|reload}\" exit 1 esac exit $RETVAL nginx.conf ç¤ºä¾‹ user openresty; worker_processes auto; #error_log logs/error.log; #error_log logs/error.log notice; #error_log logs/error.log info; # pid pid /daemon/openresty/openresty.pid; events { worker_connections 1024; } http { # å®šä¹‰æ–°çš„ä¸´æ—¶ç›®å½• proxy_temp_path /logs/openresty/proxy_temp; include mime.types; default_type application/octet-stream; log_format main '$remote_addr - $remote_user [$time_local] \"$request\" ' '$status $body_bytes_sent \"$http_referer\" ' '\"$http_user_agent\" \"$http_x_forwarded_for\" ' '\"$http_x_real_ip\" \"$http_x_forwarded_host\" ' '\"$http_x_forwarded_proto\"' '\"$request_time\" \"$upstream_addr\" \"$upstream_response_time\"'; # access_log /log/openresty/access.log main; sendfile on; # å¤§æ–‡ä»¶å¤„ç† tcp_nopush on; # å¤§æ–‡ä»¶å¤„ç† # å®¢æˆ·ç«¯è¿æ¥åœ¨ Keep-Alive çŠ¶æ€ä¸‹ä¿æŒæ‰“å¼€çš„æ—¶é—´ï¼ˆç§’ï¼‰ keepalive_timeout 30; gzip on; gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript; gzip_min_length 1024; gzip_proxied any; gzip_disable \"msie6\"; gzip_vary on; # éšè—æœåŠ¡å™¨ä¿¡æ¯ç‰ˆæœ¬å· server_tokens off; # ç§»é™¤ä¸éœ€è¦çš„å“åº”å¤´éƒ¨ï¼ˆéœ€è¦ ngx_headers_more æ¨¡å—ï¼‰ more_clear_headers \"X-Powered-By\"; more_clear_headers \"Server\"; more_clear_headers \"X-Content-Type-Options\"; # ä¸Šä¼ æ–‡ä»¶ client_max_body_size 10M; client_body_buffer_size 8M; # å®šä¹‰å…±äº«å†…å­˜åŒºåŸŸ limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:10m; limit_req_zone $binary_remote_addr zone=req_limit_per_ip:10m rate=10r/s; # æé«˜é€Ÿç‡é™åˆ¶ # lua #access_by_lua_file \"lua æ–‡ä»¶ç›®å½•\"; add_header X-HTTP-Method-Override \"\"; # ç¦ç”¨ä¼ªé€ çš„æ–¹æ³• # å¯ä»¥å¢å¼ºæµè§ˆå™¨çš„å®‰å…¨æ€§ï¼Œé˜²æ­¢ XSS æ”»å‡»å’Œå…¶ä»–å®‰å…¨æ¼æ´ add_header X-Content-Type-Options nosniff always; # é˜²æ­¢ MIME ç±»å‹å—…æ¢ # ç¦ç”¨è·¨ç«™è¯·æ±‚ä¼ªé€ ï¼ˆCSRFï¼‰ add_header Referrer-Policy \"no-referrer\"; # é˜²æ­¢ç‚¹å‡»åŠ«æŒï¼Œç›¸åŒåŸŸåiframeå¼•ç”¨ # add_header X-Frame-Options SAMEORIGIN; add_header X-XSS-Protection \"1; mode=block\" always; # é˜²æ­¢è·¨ç«™è„šæœ¬æ”»å‡» (XSS) add_header X-Content-Type-Options \"nosniff\"; # é˜²æ­¢æµè§ˆå™¨è§£è¯»å“åº”çš„MIMEç±»å‹ add_header X-Frame-Options \"DENY\"; # é˜²æ­¢ç‚¹å‡»åŠ«æŒï¼ˆClickjackingï¼‰ add_header Set-Cookie \"name=value; SameSite=Strict\"; # é˜²æ­¢è·¨ç«™è¯·æ±‚ä¼ªé€  (CSRF) # å¯ç”¨ Content Security Policy (CSP), è®¾ç½® CSP å¤´ä»¥é˜²æ­¢å¤–éƒ¨è„šæœ¬å’Œèµ„æºçš„åŠ è½½ï¼Œä»è€Œé˜²æ­¢ XSS æ”»å‡» add_header X-Content-Security-Policy \"default-src 'self'; script-src 'self'; object-src 'none'; style-src 'self'; frame-ancestors 'none';\"; # CSP é˜²èŒƒæ”»å‡» add_header Content-Security-Policy \"default-src 'self'; script-src 'self'; object-src 'none'; style-src 'self';\"; # cache é…ç½® proxy_cache_path /logs/openresty/cache levels=1:2 keys_zone=my_cache:10m max_size=1g inactive=60m use_temp_path=off; proxy_cache_key \"$scheme$request_method$host$request_uri\"; # www # include /fate/openresty/conf.d/www.conf; } conf.d/security.conf vim /fate/openresty/conf.d/security.conf chmod -R 644 /fate/openresty/conf.d # é™åˆ¶å¯¹æ•æ„Ÿæ–‡ä»¶çš„è®¿é—® location ~ /\\. { deny all; } location ~ /\\.git { deny all; } # ç¦ç”¨ä¸å¿…è¦çš„ HTTP æ–¹æ³• if ($request_method !~ ^(GET|POST|HEAD)$) { return 405; } https è¯ä¹¦ pip config set global.cache-dir \"/logs/python/pip\" pip config set global.index-url https://mirrors.aliyun.com/pypi/simple/ pip install certbot certbot-nginx certbot certonly # letsencrypté“¾æ¥ï¼Œåœ¨ä½¿ç”¨certbot certonlyåæ‰§è¡Œ # ä¹Ÿå¯ä»¥ç›´æ¥å†™åœ¨etcç›®å½•ä¸­çš„è¯ä¹¦åœ°å€åœ¨openrestyä¸­ ln -s /etc/letsencrypt/live/ /data/openresty/cert # ç”Ÿæˆçš„è¯ä¹¦åˆ—è¡¨ certbot certificates # åˆ é™¤ç”Ÿæˆçš„è¯ä¹¦ certbot delete --cert-name # åˆ·æ–°è¯ä¹¦ certbot renew å®šæ—¶ä»»åŠ¡ç›¸å…³ crontab -e # è¾“å…¥å†…å®¹ # ... # ä¿å­˜å®Œæˆåé‡å¯ systemctl restart crond æ—¥å¿—è½®è½¬ vim /etc/logrotate.d/openresty ç¼–è¾‘æ–‡ä»¶æ—¶è¦ åˆ é™¤#æ³¨é‡Š\n/logs/openresty/*.log { daily # æ¯å¤©è½®è½¬æ—¥å¿— rotate 7 # ä¿ç•™7ä¸ªæ—¥å¿—æ–‡ä»¶ size 50M # å½“æ—¥å¿—æ–‡ä»¶è¶…è¿‡50MBæ—¶è¿›è¡Œè½®è½¬ compress # è½®è½¬çš„æ—¥å¿—è¿›è¡Œå‹ç¼© missingok # å¦‚æœæ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™ä¸æŠ¥é”™ notifempty # å¦‚æœæ—¥å¿—ä¸ºç©ºï¼Œä¸è¿›è¡Œè½®è½¬ create 0640 openresty openresty # æ–°åˆ›å»ºçš„æ—¥å¿—æ–‡ä»¶æƒé™ } # å¼ºåˆ¶æ‰§è¡Œï¼Œæœªè¾¾åˆ°50Mä¹Ÿä¼šç”Ÿæˆ.gzæ–‡ä»¶ logrotate -f /etc/logrotate.d/openresty redis å®˜ç½‘ ä¸‹è½½\nredis # chkconfig: - 50 90\nå®‰è£… \u0026 é…ç½® è‡ªå®šä¹‰ç«¯å£ä¿®æ”¹ sed -i '139s/6379/1234/' redis.conf\ncd /download wget https://download.redis.io/releases/redis-7.4.1.tar.gz tar -zxf redis-7.4.1.tar.gz cd /download/redis-7.4.1 cd deps make hiredis lua jemalloc linenoise cd .. make -j$(nproc) make PREFIX=/env/redis install ln -s /env/redis/bin/* /usr/local/bin/ cp /download/redis-7.4.1/redis.conf /fate/redis/redis.conf.bak cp /download/redis-7.4.1/redis.conf /fate/redis/redis.conf cd /fate/redis sed -i '70s/^#\\s*//' redis.conf sed -i '156s/^#\\s*//' redis.conf sed -i '156s/\\/run/\\/daemon\\/redis/' redis.conf sed -i '157s/^#\\s*//' redis.conf sed -i '310s/no/yes/' redis.conf sed -i '342s/\\/var\\/run\\/redis_6379.pid/\\/daemon\\/redis\\/redis_6379.pid/' redis.conf sed -i '356s/\"\"/\\/logs\\/redis\\/redis.log/' redis.conf sed -i '1050s/^# requirepass foobared/requirepass redis/' redis.conf sed -i '1085s/^#\\s*//' redis.conf sed -i '$ a\\rename-command FLUSHDB \"\"\\nrename-command FLUSHALL \"\"' redis.conf å¼€æœºè‡ªåŠ¨å¯åŠ¨ vim /etc/init.d/redis chmod +x /etc/init.d/redis chkconfig --add /etc/init.d/redis chkconfig redis on /etc/init.d/redis #!/bin/sh # chkconfig: - 50 90 # description: Redis æœåŠ¡åˆå§‹åŒ–è„šæœ¬ï¼Œç”¨äºåœ¨ç³»ç»Ÿå¯åŠ¨æ—¶å¯åŠ¨ Redisï¼Œå¹¶åœ¨è¿è¡Œæ—¶è¿›è¡Œç®¡ç† # Increase file descriptor limit # LimitNOFILE æ˜¯æ§åˆ¶ç³»ç»Ÿå…è®¸æ¯ä¸ªè¿›ç¨‹å¯ä»¥æ‰“å¼€çš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ•°ã€‚å¢åŠ æ­¤é™åˆ¶å¯ä»¥é˜²æ­¢ Redis åœ¨å¤„ç†å¤§é‡å¹¶å‘è¿æ¥æ—¶é‡åˆ° \"too many open files\" é”™è¯¯ã€‚ # LimitNOFILE=10032 # æ— æ•ˆ # Redis æœåŠ¡ç«¯å£ REDISPORT=6379 # Redis æœåŠ¡å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ EXEC=/env/redis/bin/redis-server # Redis å®¢æˆ·ç«¯å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ CLIEXEC=/env/redis/bin/redis-cli # PID æ–‡ä»¶è·¯å¾„ï¼Œç”¨äºè®°å½• Redis æœåŠ¡çš„è¿›ç¨‹ ID PIDFILE=\"/daemon/redis/redis_${REDISPORT}.pid\" # Redis é…ç½®æ–‡ä»¶è·¯å¾„ CONF=\"/fate/redis/redis.conf\" # Redis æœåŠ¡å¯†ç  PASSWORD=\"redis\" # æ ¹æ®ä¼ å…¥çš„å‚æ•°æ‰§è¡Œç›¸åº”æ“ä½œ case \"$1\" in start) # å¯åŠ¨ Redis æœåŠ¡ if [ -f $PIDFILE ]; then echo \"$PIDFILE å·²å­˜åœ¨ï¼Œè¿›ç¨‹å·²ç»åœ¨è¿è¡Œæˆ–å´©æºƒ\" else # è®¾ç½® Redis æ‰€éœ€çš„æ–‡ä»¶æè¿°ç¬¦é™åˆ¶ ulimit -n 10032 echo \"æ­£åœ¨å¯åŠ¨ Redis æœåŠ¡å™¨...\" $EXEC $CONF --requirepass $PASSWORD fi ;; stop) # åœæ­¢ Redis æœåŠ¡ if [ ! -f $PIDFILE ]; then echo \"$PIDFILE ä¸å­˜åœ¨ï¼Œè¿›ç¨‹æœªè¿è¡Œ\" else PID=$(cat $PIDFILE) echo \"æ­£åœ¨åœæ­¢ Redis...\" $CLIEXEC -p $REDISPORT -a $PASSWORD shutdown # ç­‰å¾… Redis è¿›ç¨‹å®Œå…¨åœæ­¢ while [ -x /proc/${PID} ]; do echo \"ç­‰å¾… Redis åœæ­¢...\" sleep 1 done echo \"Redis å·²åœæ­¢\" fi ;; *) # æç¤ºæ­£ç¡®çš„ä½¿ç”¨æ–¹æ³• echo \"è¯·ä½¿ç”¨ start æˆ– stop ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°\" ;; esac æµ‹è¯•è¿æ¥ redis-server /fate/redis/redis.conf redis-cli -p 6379 127.0.0.1:6379\u003e AUTH redis OK 127.0.0.1:6379\u003e ping PONG mysql å®˜ç½‘ ä¸‹è½½ 8.0.40\nmysql # chkconfig: - 55 85\nmy.cnf groupadd -r mysql useradd -r -g mysql -s /sbin/nologin mysql vim /fate/mysql/my.cnf [mysqld] # performance schemaé…ç½® performance-schema = 1 performance-schema-instrument = wait/lock/metadata/sql/mdl=ON # å¯ç”¨æ›´ä¸¥æ ¼çš„æƒé™æ£€æŸ¥ # éœ€è¦åœ¨ MySQL å¯åŠ¨æ—¶é€šè¿‡ --skip-grant-tables ç¦ç”¨æˆæƒè¡¨ skip-grant-tables=0 # è®¾ç½® MySQL å®‰è£…ç›®å½• basedir=/env/mysql # è®¾ç½® MySQL æ•°æ®ç›®å½• datadir=/data/mysql/data # è®¾ç½® socket æ–‡ä»¶è·¯å¾„ socket=/daemon/mysql/mysql.sock # é™åˆ¶ LOAD DATA å’Œ SELECT ... INTO OUTFILE æ“ä½œçš„ç›®å½• secure-file-priv=/data/mysql/mysql-files # è¿è¡Œ MySQL çš„ç”¨æˆ· user=mysql # PID æ–‡ä»¶è·¯å¾„ pid-file=/daemon/mysql/mysql.pid # æœ€å¤§è¿æ¥æ•° max_connections=1000 # è®¾ç½®çº¿ç¨‹ç¼“å­˜å¤§å° thread_cache_size = 200 # æ ¹æ®è¿æ¥æ•°è®¾ç½®ï¼Œå‡å°‘çº¿ç¨‹åˆ›å»ºå’Œé”€æ¯çš„å¼€é”€ # è®¾ç½®æ¯ä¸ªçº¿ç¨‹çš„å †æ ˆå¤§å° thread_stack = 192K # é€‚å½“è°ƒæ•´ # è®¾ç½®æ’åºæ“ä½œçš„ç¼“å†²åŒºå¤§å° sort_buffer_size = 4M # è°ƒæ•´æ’åºæ“ä½œçš„å†…å­˜ç¼“å­˜å¤§å° # è®¾ç½®è¯»å–æ•°æ®çš„ç¼“å†²åŒºå¤§å° read_buffer_size = 4M # ç”¨äºæ‰«æå¤§æ•°æ®è¡¨çš„æŸ¥è¯¢ # è®¾ç½®è¡¨ç¼“å­˜æ•°é‡ table_open_cache = 1024 # æ ¹æ®æ‚¨çš„è¡¨æ•°é‡å’ŒæŸ¥è¯¢é¢‘ç‡è®¾ç½® # é»˜è®¤å­—ç¬¦é›†å’Œæ ¡å¯¹è§„åˆ™ character-set-server=utf8mb4 collation-server=utf8mb4_general_ci # é»˜è®¤å­˜å‚¨å¼•æ“ default-storage-engine=INNODB # SQL æ¨¡å¼ sql_mode=STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION # é”™è¯¯æ—¥å¿—æ–‡ä»¶è·¯å¾„ log-error=/logs/mysql/mysql-error.log # äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶è·¯å¾„ log-bin=/logs/mysql/mysql-bin.log # äºŒè¿›åˆ¶æ—¥å¿—è¿‡æœŸæ—¶é—´ï¼ˆ7 å¤©ï¼‰ binlog_expire_logs_seconds=604800 # æ…¢æŸ¥è¯¢ slow_query_log = 1 slow_query_log_file = /logs/mysql/mysql-slow.log long_query_time = 2 # InnoDB é…ç½® innodb_buffer_pool_size=1G # è®¾ç½® InnoDB ç¼“å†²æ± çš„å¤§å°ï¼Œå»ºè®®è®¾ç½®ä¸ºç‰©ç†å†…å­˜çš„ 70%-80%ï¼ˆå¯¹äºæ•°æ®åº“æœåŠ¡å™¨ï¼‰ # innodb_log_file_size=256M # æ ¹æ®äº‹åŠ¡é‡è¿›è¡Œè°ƒæ•´ï¼Œmysql8.0ä»¥ä¸Šä¸æ”¯æŒäº†ï¼ŒåºŸå¼ƒ innodb_redo_log_capacity=1073741824 innodb_flush_log_at_trx_commit=2 # 1 æœ€å¼ºçš„æ•°æ®å®‰å…¨æ€§ï¼Œä½†å¯èƒ½ä¼šå½±å“æ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯åœ¨é«˜å¹¶å‘çš„ç¯å¢ƒä¸­ 2 æ€§èƒ½å’Œæ•°æ®å®‰å…¨æ€§ä¹‹é—´æä¾›äº†ä¸€ä¸ªå¹³è¡¡ç‚¹ï¼Œé€‚åˆå¤§å¤šæ•°åº”ç”¨åœºæ™¯ 0 æœ€é«˜çš„æ€§èƒ½ï¼Œä½†ç‰ºç‰²äº†æ•°æ®å®‰å…¨æ€§ï¼Œé€‚åˆå¯¹æ•°æ®ä¸¢å¤±å®¹å¿åº¦è¾ƒé«˜çš„ç¯å¢ƒ innodb_file_per_table=1 innodb_flush_method=O_DIRECT innodb_read_io_threads = 4 # å¢åŠ è¯»å–çº¿ç¨‹æ•° innodb_write_io_threads = 4 # å¢åŠ å†™å…¥çº¿ç¨‹æ•° # æ¥ç¼“å†²åŒºçš„å¤§å°ï¼Œé€‚ç”¨äºå¤§æ•°æ®è¡¨çš„è¿æ¥æ“ä½œ join_buffer_size = 8M # ä¸´æ—¶è¡¨ tmp_table_size = 64M max_heap_table_size = 64M default_authentication_plugin=caching_sha2_password # ç¦æ­¢rootè¿œç¨‹ç™»å½• # skip-networking # å¦‚æœä½ éœ€è¦æ”¯æŒè¿œç¨‹è¿æ¥ï¼Œä¸è¦å¯ç”¨ skip-networking skip-name-resolve # å¦‚æœä½ å¸Œæœ›é¿å… DNS è§£æå¸¦æ¥çš„æ€§èƒ½å¼€é”€ï¼Œå¹¶ç¡®ä¿æ‰€æœ‰è¿æ¥åŸºäº IP åœ°å€ï¼Œå¯ä»¥å¯ç”¨ skip-name-resolveï¼Œä½†è¦ç¡®ä¿æ‰€æœ‰æƒé™é…ç½®éƒ½ä½¿ç”¨ IP åœ°å€ï¼Œè€Œä¸æ˜¯ä¸»æœºå # è¯»å†™åˆ†ç¦» # å¯¹äºè´Ÿè½½è¾ƒé‡çš„ç³»ç»Ÿï¼Œè®¾ç½®è¯»å†™åˆ†ç¦»ï¼Œä¸»åº“å¤„ç†å†™æ“ä½œï¼Œä»åº“å¤„ç†è¯»æ“ä½œï¼Œå¯ä»¥æ˜¾è‘—æå‡æ€§èƒ½ã€‚ replicate-do-db=db1 read_only=1 # è®¾ç½®ä»åº“ä¸ºåªè¯» # å¯†é’¥ç­–ç•¥ # validate-password-policy=STRONG # validate-password-length=12 # ç¦ç”¨ç¬¦å·é“¾æ¥ \u0026 ç¦ç”¨ LOAD DATA LOCAL INFILE åŠŸèƒ½ # skip-symbolic-links # ä¸éœ€è¦æ˜¾ç¤ºå®šä¹‰äº† local-infile=0 [client] # å®¢æˆ·ç«¯é…ç½® port=3306 socket=/daemon/mysql/mysql.sock # åŒ…å«é¢å¤–çš„é…ç½®æ–‡ä»¶ # !includedir /etc/mysql/conf.d/ rpcsvc-proto cd /download wget https://github.com/thkukuk/rpcsvc-proto/releases/download/v1.4.4/rpcsvc-proto-1.4.4.tar.xz tar xf rpcsvc-proto-1.4.4.tar.xz cd rpcsvc-proto-1.4.4/ ./configure make -j$(nproc) \u0026\u0026 make install å®‰è£… cd /third/mysql wget https://archives.boost.io/release/1.77.0/source/boost_1_77_0.tar.bz2 tar -xjf /third/mysql/boost_1_77_0.tar.bz2 -C /third/mysql/ yum install openssl-devel rpcgen libtirpc-devel gcc-c++ ncurses-devel cmake libevent-devel lz4-devel libudev-devel bison openldap-devel cyrus-sasl-devel m4 -y cd /download wget https://dev.mysql.com/get/Downloads/MySQL-8.0/mysql-8.0.41.tar.gz tar -zxf mysql-8.0.41.tar.gz cd /download/mysql-8.0.41/ mkdir build cd build cmake .. -DCMAKE_INSTALL_PREFIX=/env/mysql \\ -DMYSQL_DATADIR=/data/mysql/data \\ -DSYSCONFDIR=/fate/mysql \\ -DMYSQL_UNIX_ADDR=/daemon/mysql/mysql.sock \\ -DDEFAULT_CHARSET=utf8mb4 \\ -DDEFAULT_COLLATION=utf8mb4_general_ci \\ -DWITH_MYISAM_STORAGE_ENGINE=1 \\ -DWITH_INNOBASE_STORAGE_ENGINE=1 \\ -DENABLED_LOCAL_INFILE=1 \\ -DMYSQL_TCP_PORT=3306 \\ -DWITH_DEBUG=0 \\ -DWITH_SSL=system \\ -DWITH_SYSTEMD=1 \\ -DMYSQL_MAINTAINER_MODE=0 \\ -DDOWNLOAD_BOOST=1 \\ -DWITH_BOOST=/third/mysql/boost_1_77_0 \\ -DWITH_LZ4=system \\ -DWITH_ZLIB=bundled \\ -DWITH_LIBEVENT=system make -j$(nproc) make install ln -s /env/mysql/bin/* /usr/local/bin å¼€æœºè‡ªåŠ¨å¯åŠ¨ cp /download/mysql-8.0.41/build/scripts/mysqld.service /etc/systemd/system/mysqld.service systemctl enable mysqld åˆå§‹åŒ– chmod 755 /logs/mysql /data/mysql /data/mysql/data /fate/mysql /daemon/mysql chown -R mysql:mysql /env/mysql /fate/mysql /data/mysql /logs/mysql /daemon/mysql /data/mysql/mysql-files chmod 700 /data/mysql/mysql-files chown -R mysql:mysql /env/mysql /fate/mysql /data/mysql /logs/mysql /daemon/mysql /data/mysql/mysql-files mysqld --initialize --user=mysql --basedir=/env/mysql --datadir=/data/mysql/data cat /logs/mysql/mysql-error.log é…ç½® systemctl start mysqld mysql -uroot -pÂ systemctl restart mysqld sql å¦‚ä½•å®‰è£… gitea å¯ä»¥åˆ›å»ºä¸€ä¸ª giteaçš„æ•°æ®åº“\nALTER USER root@localhost IDENTIFIED WITH caching_sha2_password BY 'your_root_passwd'; update mysql.user set host = 'localhost' WHERE user = 'root' AND host != 'localhost'; create database gitea; create user 'gitea'@'127.0.0.1' identified by 'your_gitea_passwd'; grant all privileges on gitea.* to 'gitea'@'127.0.0.1'; # åˆ é™¤æƒé™ # DROP USER 'gitea'@'127.0.0.1'; update mysql.user set Process_priv = 'Y' where user = 'gitea'; flush privileges; quit; ","wordCount":"2233","inLanguage":"en","datePublished":"2025-01-19T00:00:00Z","dateModified":"2025-01-19T00:00:00Z","author":{"@type":"Person","name":"ä»è¿Ÿ"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://rengchi.github.io/posts/env/linux/init/"},"publisher":{"@type":"Organization","name":"ä»è¿Ÿ","logo":{"@type":"ImageObject","url":"https://rengchi.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://rengchi.github.io/ accesskey=h title="ä»è¿Ÿ (Alt + H)">ä»è¿Ÿ</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://rengchi.github.io/archives/ title=ğŸŒ å½’æ¡£><span>ğŸŒ å½’æ¡£</span></a></li><li><a href=https://rengchi.github.io/search/ title=ğŸ”æœç´¢><span>ğŸ”æœç´¢</span></a></li><li><a href=https://rengchi.github.io/tags/ title=ğŸ“Œæ ‡ç­¾><span>ğŸ“Œæ ‡ç­¾</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Linux åˆå§‹åŒ–</h1><div class=post-description>æµ‹è¯•æœåŠ¡å™¨ç¯å¢ƒï¼šHuawei Cloud EulerOS 2.0</div><div class=post-meta><span title='2025-01-19 00:00:00 +0000 UTC'>2025å¹´01æœˆ19æ—¥</span>&nbsp;Â·&nbsp;ä»è¿Ÿ</div></header><div class=post-content><h1 id=å†™åœ¨å‰é¢>å†™åœ¨å‰é¢<a hidden class=anchor aria-hidden=true href=#å†™åœ¨å‰é¢>#</a></h1><blockquote><p>å½“ç„¶ï¼Œå¦‚æœä½ ä½¿ç”¨ <code>docker</code> <code>å®å¡”</code> ç­‰æ­å»ºï¼Œå°±ä¸éœ€è¿™ä¹ˆéº»çƒ¦çš„ç¼–è¯‘å®‰è£…äº†ï¼Œå¯ä»¥å¿½ç•¥</p></blockquote><h1 id=å‡†å¤‡>å‡†å¤‡<a hidden class=anchor aria-hidden=true href=#å‡†å¤‡>#</a></h1><blockquote><p><code>2222</code> æ˜¯ ssh æ–°çš„è‡ªå®šä¹‰ç«¯å£ï¼Œ<strong><em>ä½¿ç”¨äº† <code>sed -i è¡Œæ•°</code>éƒ¨åˆ†è¯·å…ˆæŸ¥çœ‹</em></strong></p></blockquote><pre tabindex=0><code>#!/bin/bash
# cls å‘½ä»¤æ·»åŠ 
ln -s /usr/bin/clear /usr/local/bin/cls
# é˜²ç«å¢™
systemctl start firewalld.service
firewall-cmd --zone=public --add-port=80/tcp --permanent
firewall-cmd --zone=public --add-port=443/tcp --permanent
firewall-cmd --zone=public --add-port=2222/tcp --permanent
# é‡å¯
systemctl restart firewalld
# å¼€æœºå¯åŠ¨
systemctl enable firewalld.service
# åˆ—è¡¨æŸ¥çœ‹
# firewall-cmd --list-ports
# ssh
cd /etc/ssh
cp sshd_config sshd_config.bak
sed -i &#39;21s/#Port 22/Port 2222/&#39; sshd_config
cd /etc
# ä¸»æœºåç§°
cp hostname hostname.bak
echo &#34;Rengchi&#34; &gt; hostname
cd /etc/
cp sysctl.conf sysctl.conf.bak
sed -i &#39;$a vm.overcommit_memory = 1&#39; /etc/sysctl.conf
sudo sed -i &#39;$a net.ipv4.tcp_max_syn_backlog = 4096&#39; /etc/sysctl.conf
sudo sed -i &#39;$a net.ipv4.tcp_fin_timeout = 15&#39; /etc/sysctl.conf
sysctl -p
reboot
</code></pre><h1 id=vimrc>.vimrc<a hidden class=anchor aria-hidden=true href=#vimrc>#</a></h1><h2 id=vim-ç›®å½•>vim ç›®å½•<a hidden class=anchor aria-hidden=true href=#vim-ç›®å½•>#</a></h2><pre tabindex=0><code>cd
mkdir .vim .vim/backup .vim/undo
</code></pre><pre tabindex=0><code>&#34; è®©é…ç½®å˜æ›´ç«‹å³ç”Ÿæ•ˆ
autocmd BufWritePost $MYVIMRC source $MYVIMRC

&#34; åŸºç¡€è®¾ç½®
set nocompatible            &#34; ä¸å…¼å®¹ vi
set noswapfile              &#34; ä¸ç”Ÿæˆ swap æ–‡ä»¶
set autowrite               &#34; è®¾ç½®è‡ªåŠ¨ä¿å­˜
set confirm                 &#34; æœªä¿å­˜æˆ–åªè¯»æ–‡ä»¶æ—¶å¼¹å‡ºç¡®è®¤æ¡†
set number                  &#34; æ˜¾ç¤ºè¡Œå·
set autoindent              &#34; è‡ªåŠ¨ç¼©è¿›
set smartindent             &#34; æ™ºèƒ½ç¼©è¿›
&#34; set mouse=a                 &#34; å¯ç”¨é¼ æ ‡æ”¯æŒ
syntax on                   &#34; å¼€å¯è¯­æ³•é«˜äº®

&#34; Tab å’Œç¼©è¿›è®¾ç½®
set tabstop=4               &#34; è®¾ç½® Tab ä¸º 4 ä¸ªç©ºæ ¼
set shiftwidth=4            &#34; è®¾ç½®ç¼©è¿›å®½åº¦ä¸º 4 ä¸ªç©ºæ ¼
set softtabstop=4           &#34; è®¾ç½® Tab ä¸º 4 ä¸ªç©ºæ ¼
set expandtab               &#34; ç”¨ç©ºæ ¼æ›¿ä»£ Tab

&#34; ç¼–ç è®¾ç½®
set fileencodings=utf-8,ucs-bom,gb18030,gbk,gb2312,cp936
set termencoding=utf-8
set encoding=utf-8

&#34; è‡ªåŠ¨åŠ è½½
set autoread

&#34; æ–‡æœ¬æ˜¾ç¤ºè®¾ç½®
set linebreak               &#34; ä¸æ¢è¡Œæ–­å­—
set showmatch               &#34; é«˜äº®åŒ¹é…æ‹¬å·
set cursorline              &#34; çªå‡ºæ˜¾ç¤ºå½“å‰è¡Œ
set ruler                   &#34; æ‰“å¼€çŠ¶æ€æ æ ‡å°º

&#34; æœç´¢è®¾ç½®
set hlsearch                &#34; æœç´¢æ—¶é«˜äº®åŒ¹é…çš„è¯
set incsearch               &#34; è¾¹è¾“å…¥è¾¹æœç´¢
set ignorecase              &#34; æœç´¢æ—¶å¿½ç•¥å¤§å°å†™
set smartcase               &#34; å½“æœç´¢åŒ…å«å¤§å†™å­—æ¯æ—¶ï¼Œæœç´¢åŒºåˆ†å¤§å°å†™

&#34; ä¸­æ–‡å¸®åŠ©è®¾ç½®
set helplang=cn             &#34; è®¾ç½®ä¸­æ–‡å¸®åŠ©
set ambiwidth=double        &#34; è®¾ç½®åŒå­—å®½æ˜¾ç¤ºï¼Œé˜²æ­¢å­—ç¬¦ä¸å®Œæ•´

&#34; å¤‡ä»½ä¸æ’¤é”€æ–‡ä»¶è®¾ç½®
set backup                  &#34; å¼€å¯å¤‡ä»½æ–‡ä»¶
set backupdir=~/.vim/backup  &#34; è®¾ç½®å¤‡ä»½æ–‡ä»¶å­˜æ”¾è·¯å¾„
set undofile                &#34; å¼€å¯æ’¤é”€å†å²è®°å½•æ–‡ä»¶
set undodir=~/.vim/undo      &#34; è®¾ç½®æ’¤é”€æ–‡ä»¶å­˜æ”¾è·¯å¾„

&#34; å¿«æ·é”®æ˜ å°„
let mapleader = &#34;,&#34;         &#34; å®šä¹‰ &lt;leader&gt; é”®
nnoremap &lt;leader&gt;e :e ~/.vimrc&lt;cr&gt;           &#34; å¿«é€Ÿæ‰“å¼€ vim é…ç½®æ–‡ä»¶
nnoremap &lt;leader&gt;r :source $MYVIMRC&lt;cr&gt;      &#34; åˆ·æ–°é…ç½®
nnoremap &lt;c-d&gt; yyp                          &#34; Ctrl+d å¤åˆ¶æœ¬è¡Œå¹¶ç²˜è´´åˆ°ä¸‹ä¸€è¡Œ
inoremap ;; &lt;Esc&gt;                           &#34; å°† ESC é”®æ˜ å°„ä¸ºä¸¤æ¬¡ ; é”®
nnoremap &lt;leader&gt;q :q&lt;cr&gt;                   &#34; &lt;leader&gt;+q å¿«é€Ÿé€€å‡º vim
inoremap &lt;leader&gt;q &lt;Esc&gt;:q&lt;cr&gt;
nnoremap &lt;leader&gt;s :w&lt;cr&gt;                   &#34; &lt;leader&gt;+s å¿«é€Ÿä¿å­˜
inoremap &lt;leader&gt;s &lt;Esc&gt;:w&lt;cr&gt;

&#34; æ’å…¥æ¨¡å¼ã€æ­£å¸¸æ¨¡å¼æŒ‰ Ctrl+u å¿«é€Ÿè½¬æ¢ä¸ºå¤§å†™
inoremap &lt;c-u&gt; &lt;esc&gt;viwUea
nnoremap &lt;c-u&gt; viwUe

&#34; æ–‡ä»¶å¤´éƒ¨ç­¾åä¿¡æ¯ç®¡ç†
nmap &lt;F6&gt; ms:call TitleDet() &lt;cr&gt;&#39;s
function AddTitle()
    call append (0,&#34;/*********************************************************************&#34;)
    call append (1,&#34; * Author           : ä»è¿Ÿ&#34;)
    call append (2,&#34; * Create At        : &#34;.strftime(&#34;%Y-%m-%d %H:%M&#34;))
    call append (3,&#34; * Filename         : &#34;.expand(&#34;%:t&#34;))
    call append (4,&#34; * Description      : çŸ¥ä¹‹è¡Œä¹‹ï¼Œæ— è´Ÿä»Šæ—¥&#34;)
    call append (5,&#34; * ******************************************************************/&#34;)
    echohl WarningMsg | echo &#34;æ·»åŠ æˆåŠŸ !!&#34; | echohl None
endfunction
function UpdateTitle()
    normal m&#39;
    execute &#39;/* Last modified\s*:/s@:.*$@\=strftime(&#34;: %Y-%m-%d %H:%M&#34;)@&#39;
    normal &#39;&#39;
    normal mk
    execute &#39;/* Filename\s*:/s@:.*$@\=&#34;: &#34;.expand(&#34;%:t&#34;)@&#39;
    execute &#34;noh&#34;
    normal &#39;k
    echohl WarningMsg | echo &#34;æ›´æ–°æˆåŠŸ !!&#34; | echohl None
endfunction
function TitleDet()
    let n=1
    while n&lt;8
       let line = getline(n)
       if line =~ &#39;^\s*\*\s*Last\smodified\s*:\s*\S*.*$&#39;
        call UpdateTitle()
    return
       endif
       let n = n+1
    endwhile
    call AddTitle()
endfunction

&#34; æŸ¥æ‰¾ä¸æ›¿æ¢
nnoremap &lt;C-f&gt; /
nnoremap &lt;C-h&gt; :%s/
nnoremap &lt;leader&gt;sf :!grep -ri

&#34; å…è®¸å…‰æ ‡é”®è·¨è¡Œï¼Œå…‰æ ‡å¯ä»¥å‡ºç°åœ¨æœ€åä¸€ä¸ªå­—ç¬¦å
set whichwrap+=&lt;,&gt;,h,l
set virtualedit=block,onemore
</code></pre><h1 id=ç¯å¢ƒå®‰è£…ç›®å½•>ç¯å¢ƒå®‰è£…ç›®å½•<a hidden class=anchor aria-hidden=true href=#ç¯å¢ƒå®‰è£…ç›®å½•>#</a></h1><blockquote><p><code>/data</code> ç›®å½•æœ‰å¯ä»¥ä½¿ç”¨é‡å¤ï¼Œéœ€è¦å…ˆæŸ¥çœ‹æ˜¯å¦å­˜åœ¨</p></blockquote><blockquote><p><code>/fate </code>ç›®å½•ä¸ºå­˜å‚¨é…ç½®æ–‡ä»¶ç›®å½•</p></blockquote><pre tabindex=0><code>cd
mkdir /env /logs /download /third /daemon /data /proj
mkdir /logs/openresty /logs/openresty/proxy_temp /logs/redis /logs/mysql /fate
mkdir /third/mysql
mkdir /fate/openresty /fate/openresty/lua /fate/openresty/conf.d /fate/redis /fate/mysql
mkdir /daemon/openresty /daemon/redis /daemon/mysql
mkdir /data/mysql /data/mysql/data /data/mysql/mysql-files
mkdir /proj/html /proj/go
chmod 755 /env /fate /data /download /proj
chmod -R 755 /logs/openresty /daemon /proj/html
chmod 777 /logs
</code></pre><h1 id=goå¯é€‰>goï¼ˆå¯é€‰ï¼‰<a hidden class=anchor aria-hidden=true href=#goå¯é€‰>#</a></h1><blockquote><p>go é¡¹ç›®ç›´æ¥æŠŠæ‰“åŒ…åçš„æ”¾åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œå°±å¯ä»¥ï¼Œæˆ–è€…ä½¿ç”¨ docker</p></blockquote><h2 id=å®‰è£…>å®‰è£…<a hidden class=anchor aria-hidden=true href=#å®‰è£…>#</a></h2><pre tabindex=0><code>cd /download
wget https://golang.google.cn/dl/go1.23.5.linux-amd64.tar.gz
tar -zxf go1.23.5.linux-amd64.tar.gz
mv /download/go /env/
rm -rf /download/go
ln -s /env/go/bin/* /usr/local/bin/
go env -w GOPATH=/proj/go
go env -w GOROOT=/env/go
go env -w GOBIN=/proj/go/bin
go env -w GOPROXY=https://goproxy.cn,direct
go env -w GOCACHE=/logs/go/go-build
go env -w GOMODCACHE=/logs/go/pkg/mod
go env -w GO111MODULE=on
</code></pre><h2 id=å‘½ä»¤è‡ªåŠ¨è¡¥å…¨>å‘½ä»¤è‡ªåŠ¨è¡¥å…¨<a hidden class=anchor aria-hidden=true href=#å‘½ä»¤è‡ªåŠ¨è¡¥å…¨>#</a></h2><blockquote><p>ä¸­é€”éœ€è¦è¾“å…¥ä¸€ä¸ª <code>y</code></p></blockquote><pre tabindex=0><code>go install github.com/posener/complete/gocomplete@latest
/proj/go/bin/gocomplete -install
</code></pre><h2 id=ç¯å¢ƒå˜é‡>ç¯å¢ƒå˜é‡<a hidden class=anchor aria-hidden=true href=#ç¯å¢ƒå˜é‡>#</a></h2><pre tabindex=0><code>ln -s /proj/go/bin/* /usr/local/bin/
</code></pre><h1 id=git>git<a hidden class=anchor aria-hidden=true href=#git>#</a></h1><h2 id=å®‰è£…-1>å®‰è£…<a hidden class=anchor aria-hidden=true href=#å®‰è£…-1>#</a></h2><pre tabindex=0><code>cd /download
yum install zlib-devel -y
wget https://www.kernel.org/pub/software/scm/git/git-2.48.1.tar.gz
tar -zxf git-2.48.1.tar.gz
cd git-2.48.1
./configure --prefix=/env/git
make -j$(nproc)
make install
ln -s /env/git/bin/* /usr/local/bin
</code></pre><h2 id=å‘½ä»¤è‡ªåŠ¨è¡¥å…¨-1>å‘½ä»¤è‡ªåŠ¨è¡¥å…¨<a hidden class=anchor aria-hidden=true href=#å‘½ä»¤è‡ªåŠ¨è¡¥å…¨-1>#</a></h2><blockquote><p>ï¼æ³¨ <code>./root/.bashrc</code></p></blockquote><pre tabindex=0><code>cd
wget https://raw.githubusercontent.com/git/git/master/contrib/completion/git-completion.bash
mv /root/git-completion.bash /etc/bash_completion.d/
cat &gt;&gt; .bashrc &lt;&lt; EOF
if [ -f /etc/bash_completion.d/git-completion.bash ]; then
. /etc/bash_completion.d/git-completion.bash
fi
EOF
. /root/.bashrc
</code></pre><h2 id=æ‰©å±•>æ‰©å±•<a hidden class=anchor aria-hidden=true href=#æ‰©å±•>#</a></h2><h3 id=gitea>gitea<a hidden class=anchor aria-hidden=true href=#gitea>#</a></h3><blockquote><p>! æ­å»ºä¸­éœ€è¦ä½¿ç”¨ <code>mysql</code> <code>openresty</code> åä»£ï¼Œéœ€è¦åœ¨å®‰è£…å®Œæˆåæœ€åé…ç½®</p></blockquote><p><a href=https://github.com/go-gitea/gitea>github</a> <a href=https://about.gitea.com/>gitea</a> <a href=https://docs.gitea.com/zh-cn/>ä¸­æ–‡æ–‡æ¡£</a> <a href=https://dl.gitea.com/gitea/>ä¸‹è½½</a></p><h4 id=-è¯·åœ¨é˜…è¯»ç›¸å…³æ–‡æ¡£åå®‰è£…ç†Ÿæ‚‰åå†å®‰è£…åˆ°ç”Ÿäº§ç¯å¢ƒ>! è¯·åœ¨é˜…è¯»ç›¸å…³æ–‡æ¡£åå®‰è£…ï¼Œç†Ÿæ‚‰åå†å®‰è£…åˆ°ç”Ÿäº§ç¯å¢ƒ<a hidden class=anchor aria-hidden=true href=#-è¯·åœ¨é˜…è¯»ç›¸å…³æ–‡æ¡£åå®‰è£…ç†Ÿæ‚‰åå†å®‰è£…åˆ°ç”Ÿäº§ç¯å¢ƒ>#</a></h4><p><a href=https://www.cnblogs.com/Gitea/p/install-gitea-service.html>ç­¾åéªŒè¯</a></p><pre tabindex=0><code>useradd -r -m -d /home/gitea -s /bin/bash gitea
su gitea
cd
wget https://github.com/go-gitea/gitea/releases/download/v1.22.5/gitea-1.22.5-linux-amd64
wget https://github.com/go-gitea/gitea/releases/download/v1.22.5/gitea-1.22.5-linux-amd64.asc
gpg --edit-key 7C9E68152594688862D62AF62D9AE806EC1592E2
gpg --keyserver hkp://pgp.mit.edu --recv 7C9E68152594688862D62AF62D9AE806EC1592E2
gpg --verify gitea-1.22.5-linux-amd64.asc gitea-1.22.5-linux-amd64
mv gitea-1.22.5-linux-amd64 gitea
chmod +x /home/gitea/gitea
./gitea web --port 3000
systemctl enable gitea
systemctl start gitea
systemctl status gitea
</code></pre><h4 id=giteaservice>gitea.service<a hidden class=anchor aria-hidden=true href=#giteaservice>#</a></h4><blockquote><p><code>vim /etc/systemd/system/gitea.service</code></p></blockquote><pre tabindex=0><code>[Unit]
Description=Gitea
Documentation=https://docs.gitea.io
After=network.target

[Service]
User=gitea
Group=gitea
ExecStart=/home/gitea/gitea web
RestartSec=3
Restart=always
Environment=GITEA_WORK_DIR=/home/gitea
Environment=GITEA_CUSTOM=/home/gitea/custom
WorkingDirectory=/home/gitea
LimitNOFILE=4096

[Install]
WantedBy=multi-user.target
</code></pre><h4 id=giteaconf>gitea.conf<a hidden class=anchor aria-hidden=true href=#giteaconf>#</a></h4><blockquote><p>å¦‚æœå¼€å¯ <code>https</code> çš„è¯ï¼Œæ³¨æ„è¯ä¹¦é…ç½®é¡¹</p></blockquote><pre tabindex=0><code># gitea
server {
    listen       80;
    server_name  gitea.yourhost.com;
    return  301 https://$server_name$request_uri;
}

server {
    listen 443 ssl;
    server_name gitea.yourhost.com;

    # å¼ºåˆ¶æµè§ˆå™¨ä½¿ç”¨ HTTPS
    add_header Strict-Transport-Security &#34;max-age=31536000; includeSubDomains&#34; always;

    ssl_certificate      /data/openresty/cert/gitea.yourhost.com/fullchain.pem;
    ssl_certificate_key  /data/openresty/cert/gitea.yourhost.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;  # ä»…æ”¯æŒ TLSv1.2 å’Œ TLSv1.3
    ssl_ciphers &#39;TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:...&#39;;  # é€‰æ‹©å®‰å…¨çš„åŠ å¯†å¥—ä»¶
    ssl_prefer_server_ciphers on;  # å¼ºåˆ¶æœåŠ¡å™¨ä¼˜å…ˆé€‰æ‹©åŠ å¯†å¥—ä»¶
    ssl_session_cache shared:SSL:1m;
    ssl_session_timeout 5m;

    access_log /logs/openresty/gitea.access.log;
    error_log /logs/openresty/gitea.error.log;

    location / {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Range $http_range;
        proxy_set_header If-Range $http_if_range;
        proxy_redirect off;
        proxy_pass http://127.0.0.1:3000;
    }
}
</code></pre><h1 id=openresty>openresty<a hidden class=anchor aria-hidden=true href=#openresty>#</a></h1><p><a href=https://openresty.org/cn/>openresty å®˜ç½‘</a></p><h2 id=å®‰è£…-2>å®‰è£…<a hidden class=anchor aria-hidden=true href=#å®‰è£…-2>#</a></h2><blockquote><p>æœåŠ¡å™¨ä¸èƒ½ç›´æ¥ä½¿ç”¨ <code>yum</code> å®‰è£…ï¼Œè¿™é‡Œé€‰æ‹©ä¸‹è½½ç¼–è¯‘å®‰è£…</p></blockquote><pre tabindex=0><code>yum install pcre-devel zlib-devel openssl-devel geoip-devel jemalloc-devel -y
cd /download
wget https://mirrors.huaweicloud.com/openresty/v1.25.3.2/openresty-1.25.3.2.tar.gz
tar -zxf openresty-1.25.3.2.tar.gz
cd /download/openresty-1.25.3.2
./configure --prefix=/env/openresty \
            --conf-path=/fate/openresty/nginx.conf \
            --error-log-path=/logs/openresty/error.log \
            --http-log-path=/logs/openresty/access.log \
            --pid-path=/daemon/openresty/openresty.pid \
            --with-http_v2_module \
            --with-http_realip_module \
            --with-http_stub_status_module \
            --with-luajit \
            --with-cc=gcc \
            --with-stream \
            --with-stream_ssl_module \
            --with-http_ssl_module \
            --with-http_sub_module \
            --with-http_secure_link_module \
            --with-http_gzip_static_module \
            --with-http_auth_request_module \
            --with-pcre-jit \
            --with-threads \
            --with-http_geoip_module \
            --with-poll_module \
            --with-ld-opt=&#34;-ljemalloc&#34; \
            --with-http_dav_module \
            --with-http_flv_module \
            --with-http_mp4_module \
            --with-http_slice_module \
            --with-file-aio

gmake -j$(nproc)
gmake install
groupadd -r openresty
useradd -r -g openresty -s /sbin/nologin openresty
ln -s /env/openresty/bin/openresty /usr/local/bin/
chmod 755 /env/openresty
chown -R openresty:openresty /env/openresty
chmod 644 /env/openresty/lualib
chown -R openresty:openresty /env/openresty/lualib/
chmod -R 644 /env/openresty/lualib/resty
chown -R openresty:openresty /env/openresty/lualib/resty
chmod -R 755 /proj/html
chmod 755 /fate/openresty
chown -R openresty:openresty /fate/openresty
chmod -R 644 /fate/openresty/conf.d
chown -R openresty:openresty /fate/openresty/conf.d
</code></pre><h2 id=å¼€æœºè‡ªåŠ¨å¯åŠ¨>å¼€æœºè‡ªåŠ¨å¯åŠ¨<a hidden class=anchor aria-hidden=true href=#å¼€æœºè‡ªåŠ¨å¯åŠ¨>#</a></h2><blockquote><p><code>openresty</code> # chkconfig: - 60 80</p></blockquote><pre tabindex=0><code>vim /etc/init.d/openresty
chmod +x /etc/init.d/openresty
chkconfig --add openresty
chkconfig openresty on
</code></pre><pre tabindex=0><code>#!/bin/bash
# chkconfig: - 60 80
# OpenResty æœåŠ¡åˆå§‹åŒ–è„šæœ¬
# ç”¨äºåœ¨ç³»ç»Ÿå¯åŠ¨æ—¶å¯åŠ¨ OpenRestyï¼ŒåŠåœ¨è¿è¡Œæ—¶è¿›è¡Œç®¡ç†

nginxd=/env/openresty/nginx/sbin/nginx
nginx_config=/fate/openresty/nginx.conf
nginx_pid=/daemon/openresty/openresty.pid
RETVAL=0
prog=&#34;OpenResty&#34;

# å¯¼å…¥å‡½æ•°åº“
. /etc/rc.d/init.d/functions

# å¯¼å…¥ç½‘ç»œé…ç½®
. /etc/sysconfig/network

# æ£€æŸ¥ç½‘ç»œæ˜¯å¦å¯åŠ¨
[ ${NETWORKING} = &#34;no&#34; ] &amp;&amp; exit 0

# æ£€æŸ¥ nginx å¯æ‰§è¡Œæ–‡ä»¶æ˜¯å¦å­˜åœ¨
[ -x $nginxd ] || exit 0

# å¯åŠ¨ OpenResty æœåŠ¡
start() {
    if [ -e $nginx_pid ]; then
        echo &#34;$prog å·²ç»åœ¨è¿è¡Œ...&#34;
        exit 1
    fi
    echo -n $&#34;å¯åŠ¨ $prog: &#34;
    daemon $nginxd -c ${nginx_config}
    RETVAL=$?
    echo
    [ $RETVAL = 0 ] &amp;&amp; touch /daemon/openresty/openresty.lock
    return $RETVAL
}

# åœæ­¢ OpenResty æœåŠ¡
stop() {
    echo -n $&#34;åœæ­¢ $prog: &#34;
    killproc $nginxd
    RETVAL=$?
    echo
    [ $RETVAL = 0 ] &amp;&amp; rm -f /daemon/openresty/openresty.lock $nginx_pid
}

# é‡æ–°åŠ è½½ OpenResty é…ç½®
reload() {
    echo -n $&#34;é‡æ–°åŠ è½½ $prog: &#34;
    killproc $nginxd -HUP
    RETVAL=$?
    echo
}

# æ ¹æ®ä¼ å…¥çš„å‚æ•°æ‰§è¡Œç›¸åº”æ“ä½œ
case &#34;$1&#34; in
start)
    start
    ;;
stop)
    stop
    ;;
reload)
    reload
    ;;
restart)
    stop
    start
    ;;
status)
    status $nginxd
    RETVAL=$?
    ;;
*)
    echo $&#34;ç”¨æ³•: $prog {start|stop|status|restart|reload}&#34;
    exit 1
esac

exit $RETVAL
</code></pre><h2 id=nginxconf-ç¤ºä¾‹>nginx.conf ç¤ºä¾‹<a hidden class=anchor aria-hidden=true href=#nginxconf-ç¤ºä¾‹>#</a></h2><pre tabindex=0><code>user  openresty;
worker_processes  auto;

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

# pid
pid        /daemon/openresty/openresty.pid;

events {
    worker_connections  1024;
}

http {
    # å®šä¹‰æ–°çš„ä¸´æ—¶ç›®å½•
    proxy_temp_path /logs/openresty/proxy_temp;

    include       mime.types;

    default_type  application/octet-stream;

    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &#34;$request&#34; &#39;
                    &#39;$status $body_bytes_sent &#34;$http_referer&#34; &#39;
                    &#39;&#34;$http_user_agent&#34; &#34;$http_x_forwarded_for&#34; &#39;
                    &#39;&#34;$http_x_real_ip&#34; &#34;$http_x_forwarded_host&#34; &#39;
                    &#39;&#34;$http_x_forwarded_proto&#34;&#39;
                    &#39;&#34;$request_time&#34; &#34;$upstream_addr&#34; &#34;$upstream_response_time&#34;&#39;;

    # access_log  /log/openresty/access.log  main;

    sendfile        on;  # å¤§æ–‡ä»¶å¤„ç†
    tcp_nopush      on;  # å¤§æ–‡ä»¶å¤„ç†
    # å®¢æˆ·ç«¯è¿æ¥åœ¨ Keep-Alive çŠ¶æ€ä¸‹ä¿æŒæ‰“å¼€çš„æ—¶é—´ï¼ˆç§’ï¼‰ keepalive_timeout  30;

    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_disable &#34;msie6&#34;;
    gzip_vary on;

    # éšè—æœåŠ¡å™¨ä¿¡æ¯ç‰ˆæœ¬å·
    server_tokens off;

    # ç§»é™¤ä¸éœ€è¦çš„å“åº”å¤´éƒ¨ï¼ˆéœ€è¦ ngx_headers_more æ¨¡å—ï¼‰
    more_clear_headers &#34;X-Powered-By&#34;;
    more_clear_headers &#34;Server&#34;;
    more_clear_headers &#34;X-Content-Type-Options&#34;;

    # ä¸Šä¼ æ–‡ä»¶
    client_max_body_size 10M;
    client_body_buffer_size 8M;

    # å®šä¹‰å…±äº«å†…å­˜åŒºåŸŸ
    limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:10m;
    limit_req_zone $binary_remote_addr zone=req_limit_per_ip:10m rate=10r/s; # æé«˜é€Ÿç‡é™åˆ¶

    # lua
    #access_by_lua_file &#34;lua æ–‡ä»¶ç›®å½•&#34;;

     add_header X-HTTP-Method-Override &#34;&#34;; # ç¦ç”¨ä¼ªé€ çš„æ–¹æ³•
    # å¯ä»¥å¢å¼ºæµè§ˆå™¨çš„å®‰å…¨æ€§ï¼Œé˜²æ­¢ XSS æ”»å‡»å’Œå…¶ä»–å®‰å…¨æ¼æ´
     add_header X-Content-Type-Options nosniff always; # é˜²æ­¢ MIME ç±»å‹å—…æ¢
    # ç¦ç”¨è·¨ç«™è¯·æ±‚ä¼ªé€ ï¼ˆCSRFï¼‰
     add_header Referrer-Policy &#34;no-referrer&#34;;
    # é˜²æ­¢ç‚¹å‡»åŠ«æŒï¼Œç›¸åŒåŸŸåiframeå¼•ç”¨
    # add_header X-Frame-Options SAMEORIGIN;
    add_header X-XSS-Protection &#34;1; mode=block&#34; always; # é˜²æ­¢è·¨ç«™è„šæœ¬æ”»å‡» (XSS)
    add_header X-Content-Type-Options &#34;nosniff&#34;; # é˜²æ­¢æµè§ˆå™¨è§£è¯»å“åº”çš„MIMEç±»å‹
    add_header X-Frame-Options &#34;DENY&#34;; # é˜²æ­¢ç‚¹å‡»åŠ«æŒï¼ˆClickjackingï¼‰
    add_header Set-Cookie &#34;name=value; SameSite=Strict&#34;; # é˜²æ­¢è·¨ç«™è¯·æ±‚ä¼ªé€  (CSRF)
    # å¯ç”¨ Content Security Policy (CSP), è®¾ç½® CSP å¤´ä»¥é˜²æ­¢å¤–éƒ¨è„šæœ¬å’Œèµ„æºçš„åŠ è½½ï¼Œä»è€Œé˜²æ­¢ XSS æ”»å‡»
    add_header X-Content-Security-Policy &#34;default-src &#39;self&#39;; script-src &#39;self&#39;; object-src &#39;none&#39;; style-src &#39;self&#39;; frame-ancestors &#39;none&#39;;&#34;; # CSP é˜²èŒƒæ”»å‡»
    add_header Content-Security-Policy &#34;default-src &#39;self&#39;; script-src &#39;self&#39;; object-src &#39;none&#39;; style-src &#39;self&#39;;&#34;;

    # cache é…ç½®
    proxy_cache_path /logs/openresty/cache levels=1:2 keys_zone=my_cache:10m max_size=1g inactive=60m use_temp_path=off;
    proxy_cache_key &#34;$scheme$request_method$host$request_uri&#34;;

    # www
    # include /fate/openresty/conf.d/www.conf;
}
</code></pre><h2 id=confdsecurityconf>conf.d/security.conf<a hidden class=anchor aria-hidden=true href=#confdsecurityconf>#</a></h2><pre tabindex=0><code>vim /fate/openresty/conf.d/security.conf
chmod -R 644 /fate/openresty/conf.d
</code></pre><pre tabindex=0><code># é™åˆ¶å¯¹æ•æ„Ÿæ–‡ä»¶çš„è®¿é—®
location ~ /\. {
    deny all;
}

location ~ /\.git {
    deny all;
}

# ç¦ç”¨ä¸å¿…è¦çš„ HTTP æ–¹æ³•
if ($request_method !~ ^(GET|POST|HEAD)$) {
    return 405;
}
</code></pre><h2 id=https-è¯ä¹¦>https è¯ä¹¦<a hidden class=anchor aria-hidden=true href=#https-è¯ä¹¦>#</a></h2><pre tabindex=0><code>pip config set global.cache-dir &#34;/logs/python/pip&#34;
pip config set global.index-url https://mirrors.aliyun.com/pypi/simple/
pip install certbot certbot-nginx
certbot certonly

# letsencrypté“¾æ¥ï¼Œåœ¨ä½¿ç”¨certbot certonlyåæ‰§è¡Œ
# ä¹Ÿå¯ä»¥ç›´æ¥å†™åœ¨etcç›®å½•ä¸­çš„è¯ä¹¦åœ°å€åœ¨openrestyä¸­
ln -s /etc/letsencrypt/live/ /data/openresty/cert

# ç”Ÿæˆçš„è¯ä¹¦åˆ—è¡¨
certbot certificates
# åˆ é™¤ç”Ÿæˆçš„è¯ä¹¦
certbot delete --cert-name &lt;certificate_name_or_domain&gt;
# åˆ·æ–°è¯ä¹¦
certbot renew
</code></pre><h2 id=å®šæ—¶ä»»åŠ¡ç›¸å…³>å®šæ—¶ä»»åŠ¡ç›¸å…³<a hidden class=anchor aria-hidden=true href=#å®šæ—¶ä»»åŠ¡ç›¸å…³>#</a></h2><pre tabindex=0><code>crontab -e
# è¾“å…¥å†…å®¹
# ...

# ä¿å­˜å®Œæˆåé‡å¯
systemctl restart crond
</code></pre><h2 id=æ—¥å¿—è½®è½¬>æ—¥å¿—è½®è½¬<a hidden class=anchor aria-hidden=true href=#æ—¥å¿—è½®è½¬>#</a></h2><pre tabindex=0><code>vim /etc/logrotate.d/openresty
</code></pre><blockquote><p>ç¼–è¾‘æ–‡ä»¶æ—¶è¦ <code>åˆ é™¤#æ³¨é‡Š</code></p></blockquote><pre tabindex=0><code>/logs/openresty/*.log {
    daily               # æ¯å¤©è½®è½¬æ—¥å¿—
    rotate 7            # ä¿ç•™7ä¸ªæ—¥å¿—æ–‡ä»¶
    size 50M            # å½“æ—¥å¿—æ–‡ä»¶è¶…è¿‡50MBæ—¶è¿›è¡Œè½®è½¬
    compress            # è½®è½¬çš„æ—¥å¿—è¿›è¡Œå‹ç¼©
    missingok           # å¦‚æœæ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™ä¸æŠ¥é”™
    notifempty          # å¦‚æœæ—¥å¿—ä¸ºç©ºï¼Œä¸è¿›è¡Œè½®è½¬
    create 0640 openresty openresty  # æ–°åˆ›å»ºçš„æ—¥å¿—æ–‡ä»¶æƒé™
}
</code></pre><pre tabindex=0><code># å¼ºåˆ¶æ‰§è¡Œï¼Œæœªè¾¾åˆ°50Mä¹Ÿä¼šç”Ÿæˆ.gzæ–‡ä»¶
logrotate -f /etc/logrotate.d/openresty
</code></pre><h1 id=redis>redis<a hidden class=anchor aria-hidden=true href=#redis>#</a></h1><p><a href=https://redis.io/>å®˜ç½‘</a> <a href=https://download.redis.io/releases/>ä¸‹è½½</a></p><blockquote><p><code>redis</code> # chkconfig: - 50 90</p></blockquote><h2 id=å®‰è£…--é…ç½®>å®‰è£… & é…ç½®<a hidden class=anchor aria-hidden=true href=#å®‰è£…--é…ç½®>#</a></h2><blockquote><p>è‡ªå®šä¹‰ç«¯å£ä¿®æ”¹ <code>sed -i '139s/6379/1234/' redis.conf</code></p></blockquote><pre tabindex=0><code>cd /download
wget https://download.redis.io/releases/redis-7.4.1.tar.gz
tar -zxf redis-7.4.1.tar.gz
cd /download/redis-7.4.1
cd deps
make hiredis lua jemalloc linenoise
cd ..
make -j$(nproc)
make PREFIX=/env/redis install
ln -s /env/redis/bin/* /usr/local/bin/
cp /download/redis-7.4.1/redis.conf /fate/redis/redis.conf.bak
cp /download/redis-7.4.1/redis.conf /fate/redis/redis.conf
cd /fate/redis
sed -i &#39;70s/^#\s*//&#39; redis.conf
sed -i &#39;156s/^#\s*//&#39; redis.conf
sed -i &#39;156s/\/run/\/daemon\/redis/&#39; redis.conf
sed -i &#39;157s/^#\s*//&#39; redis.conf
sed -i &#39;310s/no/yes/&#39; redis.conf
sed -i &#39;342s/\/var\/run\/redis_6379.pid/\/daemon\/redis\/redis_6379.pid/&#39; redis.conf
sed -i &#39;356s/&#34;&#34;/\/logs\/redis\/redis.log/&#39; redis.conf
sed -i &#39;1050s/^# requirepass foobared/requirepass redis/&#39; redis.conf
sed -i &#39;1085s/^#\s*//&#39; redis.conf
sed -i &#39;$ a\rename-command FLUSHDB &#34;&#34;\nrename-command FLUSHALL &#34;&#34;&#39; redis.conf
</code></pre><h2 id=å¼€æœºè‡ªåŠ¨å¯åŠ¨-1>å¼€æœºè‡ªåŠ¨å¯åŠ¨<a hidden class=anchor aria-hidden=true href=#å¼€æœºè‡ªåŠ¨å¯åŠ¨-1>#</a></h2><pre tabindex=0><code>vim /etc/init.d/redis
chmod +x /etc/init.d/redis
chkconfig --add /etc/init.d/redis
chkconfig redis on
</code></pre><h3 id=etcinitdredis>/etc/init.d/redis<a hidden class=anchor aria-hidden=true href=#etcinitdredis>#</a></h3><pre tabindex=0><code>#!/bin/sh
# chkconfig: - 50 90
# description: Redis æœåŠ¡åˆå§‹åŒ–è„šæœ¬ï¼Œç”¨äºåœ¨ç³»ç»Ÿå¯åŠ¨æ—¶å¯åŠ¨ Redisï¼Œå¹¶åœ¨è¿è¡Œæ—¶è¿›è¡Œç®¡ç†

# Increase file descriptor limit
# LimitNOFILE æ˜¯æ§åˆ¶ç³»ç»Ÿå…è®¸æ¯ä¸ªè¿›ç¨‹å¯ä»¥æ‰“å¼€çš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ•°ã€‚å¢åŠ æ­¤é™åˆ¶å¯ä»¥é˜²æ­¢ Redis åœ¨å¤„ç†å¤§é‡å¹¶å‘è¿æ¥æ—¶é‡åˆ° &#34;too many open files&#34; é”™è¯¯ã€‚
# LimitNOFILE=10032 # æ— æ•ˆ


# Redis æœåŠ¡ç«¯å£
REDISPORT=6379
# Redis æœåŠ¡å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„
EXEC=/env/redis/bin/redis-server
# Redis å®¢æˆ·ç«¯å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„
CLIEXEC=/env/redis/bin/redis-cli

# PID æ–‡ä»¶è·¯å¾„ï¼Œç”¨äºè®°å½• Redis æœåŠ¡çš„è¿›ç¨‹ ID
PIDFILE=&#34;/daemon/redis/redis_${REDISPORT}.pid&#34;
# Redis é…ç½®æ–‡ä»¶è·¯å¾„
CONF=&#34;/fate/redis/redis.conf&#34;
# Redis æœåŠ¡å¯†ç 
PASSWORD=&#34;redis&#34;

# æ ¹æ®ä¼ å…¥çš„å‚æ•°æ‰§è¡Œç›¸åº”æ“ä½œ
case &#34;$1&#34; in
    start)
        # å¯åŠ¨ Redis æœåŠ¡
        if [ -f $PIDFILE ]; then
            echo &#34;$PIDFILE å·²å­˜åœ¨ï¼Œè¿›ç¨‹å·²ç»åœ¨è¿è¡Œæˆ–å´©æºƒ&#34;
        else
            # è®¾ç½® Redis æ‰€éœ€çš„æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
            ulimit -n 10032
            echo &#34;æ­£åœ¨å¯åŠ¨ Redis æœåŠ¡å™¨...&#34;
            $EXEC $CONF --requirepass $PASSWORD
        fi
        ;;
    stop)
        # åœæ­¢ Redis æœåŠ¡
        if [ ! -f $PIDFILE ]; then
            echo &#34;$PIDFILE ä¸å­˜åœ¨ï¼Œè¿›ç¨‹æœªè¿è¡Œ&#34;
        else
            PID=$(cat $PIDFILE)
            echo &#34;æ­£åœ¨åœæ­¢ Redis...&#34;
            $CLIEXEC -p $REDISPORT -a $PASSWORD shutdown
            # ç­‰å¾… Redis è¿›ç¨‹å®Œå…¨åœæ­¢
            while [ -x /proc/${PID} ]; do
                echo &#34;ç­‰å¾… Redis åœæ­¢...&#34;
                sleep 1
            done
            echo &#34;Redis å·²åœæ­¢&#34;
        fi
        ;;
    *)
        # æç¤ºæ­£ç¡®çš„ä½¿ç”¨æ–¹æ³•
        echo &#34;è¯·ä½¿ç”¨ start æˆ– stop ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°&#34;
        ;;
esac
</code></pre><h2 id=æµ‹è¯•è¿æ¥>æµ‹è¯•è¿æ¥<a hidden class=anchor aria-hidden=true href=#æµ‹è¯•è¿æ¥>#</a></h2><pre tabindex=0><code>redis-server /fate/redis/redis.conf
redis-cli -p 6379
127.0.0.1:6379&gt; AUTH redis
OK
127.0.0.1:6379&gt; ping
PONG
</code></pre><h1 id=mysql>mysql<a hidden class=anchor aria-hidden=true href=#mysql>#</a></h1><p><a href=https://www.mysql.com/cn/>å®˜ç½‘</a> <a href=https://dev.mysql.com/get/Downloads/MySQL-8.0/mysql-8.0.40.tar.gz>ä¸‹è½½ 8.0.40</a></p><blockquote><p><code>mysql</code> # chkconfig: - 55 85</p></blockquote><h2 id=mycnf>my.cnf<a hidden class=anchor aria-hidden=true href=#mycnf>#</a></h2><pre tabindex=0><code>groupadd -r mysql
useradd -r -g mysql -s /sbin/nologin mysql
vim /fate/mysql/my.cnf
</code></pre><pre tabindex=0><code>[mysqld]
# performance schemaé…ç½®
performance-schema = 1
performance-schema-instrument = wait/lock/metadata/sql/mdl=ON
# å¯ç”¨æ›´ä¸¥æ ¼çš„æƒé™æ£€æŸ¥
# éœ€è¦åœ¨ MySQL å¯åŠ¨æ—¶é€šè¿‡ --skip-grant-tables ç¦ç”¨æˆæƒè¡¨
skip-grant-tables=0

# è®¾ç½® MySQL å®‰è£…ç›®å½•
basedir=/env/mysql
# è®¾ç½® MySQL æ•°æ®ç›®å½•
datadir=/data/mysql/data
# è®¾ç½® socket æ–‡ä»¶è·¯å¾„
socket=/daemon/mysql/mysql.sock
# é™åˆ¶ LOAD DATA å’Œ SELECT ... INTO OUTFILE æ“ä½œçš„ç›®å½•
secure-file-priv=/data/mysql/mysql-files

# è¿è¡Œ MySQL çš„ç”¨æˆ·
user=mysql

# PID æ–‡ä»¶è·¯å¾„
pid-file=/daemon/mysql/mysql.pid
# æœ€å¤§è¿æ¥æ•°
max_connections=1000
# è®¾ç½®çº¿ç¨‹ç¼“å­˜å¤§å°
thread_cache_size = 200  # æ ¹æ®è¿æ¥æ•°è®¾ç½®ï¼Œå‡å°‘çº¿ç¨‹åˆ›å»ºå’Œé”€æ¯çš„å¼€é”€
# è®¾ç½®æ¯ä¸ªçº¿ç¨‹çš„å †æ ˆå¤§å°
thread_stack = 192K  # é€‚å½“è°ƒæ•´

# è®¾ç½®æ’åºæ“ä½œçš„ç¼“å†²åŒºå¤§å°
sort_buffer_size = 4M  # è°ƒæ•´æ’åºæ“ä½œçš„å†…å­˜ç¼“å­˜å¤§å°
# è®¾ç½®è¯»å–æ•°æ®çš„ç¼“å†²åŒºå¤§å°
read_buffer_size = 4M  # ç”¨äºæ‰«æå¤§æ•°æ®è¡¨çš„æŸ¥è¯¢
# è®¾ç½®è¡¨ç¼“å­˜æ•°é‡
table_open_cache = 1024  # æ ¹æ®æ‚¨çš„è¡¨æ•°é‡å’ŒæŸ¥è¯¢é¢‘ç‡è®¾ç½®

# é»˜è®¤å­—ç¬¦é›†å’Œæ ¡å¯¹è§„åˆ™
character-set-server=utf8mb4
collation-server=utf8mb4_general_ci

# é»˜è®¤å­˜å‚¨å¼•æ“
default-storage-engine=INNODB

# SQL æ¨¡å¼
sql_mode=STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION

# é”™è¯¯æ—¥å¿—æ–‡ä»¶è·¯å¾„
log-error=/logs/mysql/mysql-error.log
# äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶è·¯å¾„
log-bin=/logs/mysql/mysql-bin.log
# äºŒè¿›åˆ¶æ—¥å¿—è¿‡æœŸæ—¶é—´ï¼ˆ7 å¤©ï¼‰
binlog_expire_logs_seconds=604800

# æ…¢æŸ¥è¯¢
slow_query_log = 1
slow_query_log_file = /logs/mysql/mysql-slow.log
long_query_time = 2

# InnoDB é…ç½®
innodb_buffer_pool_size=1G # è®¾ç½® InnoDB ç¼“å†²æ± çš„å¤§å°ï¼Œå»ºè®®è®¾ç½®ä¸ºç‰©ç†å†…å­˜çš„ 70%-80%ï¼ˆå¯¹äºæ•°æ®åº“æœåŠ¡å™¨ï¼‰
# innodb_log_file_size=256M # æ ¹æ®äº‹åŠ¡é‡è¿›è¡Œè°ƒæ•´ï¼Œmysql8.0ä»¥ä¸Šä¸æ”¯æŒäº†ï¼ŒåºŸå¼ƒ
innodb_redo_log_capacity=1073741824
innodb_flush_log_at_trx_commit=2 # 1 æœ€å¼ºçš„æ•°æ®å®‰å…¨æ€§ï¼Œä½†å¯èƒ½ä¼šå½±å“æ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯åœ¨é«˜å¹¶å‘çš„ç¯å¢ƒä¸­ 2 æ€§èƒ½å’Œæ•°æ®å®‰å…¨æ€§ä¹‹é—´æä¾›äº†ä¸€ä¸ªå¹³è¡¡ç‚¹ï¼Œé€‚åˆå¤§å¤šæ•°åº”ç”¨åœºæ™¯ 0 æœ€é«˜çš„æ€§èƒ½ï¼Œä½†ç‰ºç‰²äº†æ•°æ®å®‰å…¨æ€§ï¼Œé€‚åˆå¯¹æ•°æ®ä¸¢å¤±å®¹å¿åº¦è¾ƒé«˜çš„ç¯å¢ƒ
innodb_file_per_table=1
innodb_flush_method=O_DIRECT
innodb_read_io_threads = 4  # å¢åŠ è¯»å–çº¿ç¨‹æ•°
innodb_write_io_threads = 4  # å¢åŠ å†™å…¥çº¿ç¨‹æ•°

# æ¥ç¼“å†²åŒºçš„å¤§å°ï¼Œé€‚ç”¨äºå¤§æ•°æ®è¡¨çš„è¿æ¥æ“ä½œ
join_buffer_size = 8M
# ä¸´æ—¶è¡¨
tmp_table_size = 64M
max_heap_table_size = 64M

default_authentication_plugin=caching_sha2_password
# ç¦æ­¢rootè¿œç¨‹ç™»å½•
# skip-networking # å¦‚æœä½ éœ€è¦æ”¯æŒè¿œç¨‹è¿æ¥ï¼Œä¸è¦å¯ç”¨ skip-networking
skip-name-resolve # å¦‚æœä½ å¸Œæœ›é¿å… DNS è§£æå¸¦æ¥çš„æ€§èƒ½å¼€é”€ï¼Œå¹¶ç¡®ä¿æ‰€æœ‰è¿æ¥åŸºäº IP åœ°å€ï¼Œå¯ä»¥å¯ç”¨ skip-name-resolveï¼Œä½†è¦ç¡®ä¿æ‰€æœ‰æƒé™é…ç½®éƒ½ä½¿ç”¨ IP åœ°å€ï¼Œè€Œä¸æ˜¯ä¸»æœºå
# è¯»å†™åˆ†ç¦»
# å¯¹äºè´Ÿè½½è¾ƒé‡çš„ç³»ç»Ÿï¼Œè®¾ç½®è¯»å†™åˆ†ç¦»ï¼Œä¸»åº“å¤„ç†å†™æ“ä½œï¼Œä»åº“å¤„ç†è¯»æ“ä½œï¼Œå¯ä»¥æ˜¾è‘—æå‡æ€§èƒ½ã€‚
replicate-do-db=db1
read_only=1   # è®¾ç½®ä»åº“ä¸ºåªè¯»
# å¯†é’¥ç­–ç•¥
# validate-password-policy=STRONG
# validate-password-length=12
# ç¦ç”¨ç¬¦å·é“¾æ¥ &amp; ç¦ç”¨ LOAD DATA LOCAL INFILE åŠŸèƒ½
# skip-symbolic-links # ä¸éœ€è¦æ˜¾ç¤ºå®šä¹‰äº†
local-infile=0
[client]
# å®¢æˆ·ç«¯é…ç½®
port=3306
socket=/daemon/mysql/mysql.sock

# åŒ…å«é¢å¤–çš„é…ç½®æ–‡ä»¶
# !includedir /etc/mysql/conf.d/
</code></pre><h2 id=rpcsvc-proto>rpcsvc-proto<a hidden class=anchor aria-hidden=true href=#rpcsvc-proto>#</a></h2><pre tabindex=0><code>cd /download
wget https://github.com/thkukuk/rpcsvc-proto/releases/download/v1.4.4/rpcsvc-proto-1.4.4.tar.xz
tar xf rpcsvc-proto-1.4.4.tar.xz
cd rpcsvc-proto-1.4.4/
./configure
make -j$(nproc) &amp;&amp; make install
</code></pre><h2 id=å®‰è£…-3>å®‰è£…<a hidden class=anchor aria-hidden=true href=#å®‰è£…-3>#</a></h2><pre tabindex=0><code>cd /third/mysql
wget https://archives.boost.io/release/1.77.0/source/boost_1_77_0.tar.bz2
tar -xjf /third/mysql/boost_1_77_0.tar.bz2 -C /third/mysql/
yum install openssl-devel rpcgen libtirpc-devel gcc-c++ ncurses-devel cmake libevent-devel lz4-devel libudev-devel bison openldap-devel cyrus-sasl-devel m4 -y
cd /download
wget https://dev.mysql.com/get/Downloads/MySQL-8.0/mysql-8.0.41.tar.gz
tar -zxf mysql-8.0.41.tar.gz
cd /download/mysql-8.0.41/
mkdir build
cd build
cmake .. -DCMAKE_INSTALL_PREFIX=/env/mysql \
         -DMYSQL_DATADIR=/data/mysql/data \
         -DSYSCONFDIR=/fate/mysql \
         -DMYSQL_UNIX_ADDR=/daemon/mysql/mysql.sock \
         -DDEFAULT_CHARSET=utf8mb4 \
         -DDEFAULT_COLLATION=utf8mb4_general_ci \
         -DWITH_MYISAM_STORAGE_ENGINE=1 \
         -DWITH_INNOBASE_STORAGE_ENGINE=1 \
         -DENABLED_LOCAL_INFILE=1 \
         -DMYSQL_TCP_PORT=3306 \
         -DWITH_DEBUG=0 \
         -DWITH_SSL=system \
         -DWITH_SYSTEMD=1 \
         -DMYSQL_MAINTAINER_MODE=0 \
         -DDOWNLOAD_BOOST=1 \
         -DWITH_BOOST=/third/mysql/boost_1_77_0 \
         -DWITH_LZ4=system \
         -DWITH_ZLIB=bundled \
         -DWITH_LIBEVENT=system
make -j$(nproc)
make install
ln -s /env/mysql/bin/* /usr/local/bin
</code></pre><h2 id=å¼€æœºè‡ªåŠ¨å¯åŠ¨-2>å¼€æœºè‡ªåŠ¨å¯åŠ¨<a hidden class=anchor aria-hidden=true href=#å¼€æœºè‡ªåŠ¨å¯åŠ¨-2>#</a></h2><pre tabindex=0><code>cp /download/mysql-8.0.41/build/scripts/mysqld.service /etc/systemd/system/mysqld.service
systemctl enable mysqld
</code></pre><h2 id=åˆå§‹åŒ–>åˆå§‹åŒ–<a hidden class=anchor aria-hidden=true href=#åˆå§‹åŒ–>#</a></h2><pre tabindex=0><code>chmod 755 /logs/mysql /data/mysql /data/mysql/data /fate/mysql /daemon/mysql
chown -R mysql:mysql /env/mysql /fate/mysql /data/mysql /logs/mysql /daemon/mysql /data/mysql/mysql-files
chmod 700 /data/mysql/mysql-files
chown -R mysql:mysql /env/mysql /fate/mysql /data/mysql /logs/mysql /daemon/mysql /data/mysql/mysql-files
mysqld --initialize --user=mysql --basedir=/env/mysql --datadir=/data/mysql/data
cat /logs/mysql/mysql-error.log
</code></pre><h2 id=é…ç½®>é…ç½®<a hidden class=anchor aria-hidden=true href=#é…ç½®>#</a></h2><pre tabindex=0><code>systemctl start mysqld
mysql -uroot -pÂ Â Â Â 
systemctl restart mysqld
</code></pre><h3 id=sql>sql<a hidden class=anchor aria-hidden=true href=#sql>#</a></h3><blockquote><p>å¦‚ä½•å®‰è£… <code>gitea</code> å¯ä»¥åˆ›å»ºä¸€ä¸ª <code>giteaçš„æ•°æ®åº“</code></p></blockquote><pre tabindex=0><code>ALTER USER root@localhost IDENTIFIED WITH caching_sha2_password BY &#39;your_root_passwd&#39;;
update mysql.user set host = &#39;localhost&#39; WHERE user = &#39;root&#39; AND host != &#39;localhost&#39;;
create database gitea;
create user &#39;gitea&#39;@&#39;127.0.0.1&#39; identified by &#39;your_gitea_passwd&#39;;
grant all privileges on gitea.* to &#39;gitea&#39;@&#39;127.0.0.1&#39;;
# åˆ é™¤æƒé™
# DROP USER &#39;gitea&#39;@&#39;127.0.0.1&#39;;
update mysql.user set Process_priv = &#39;Y&#39; where user = &#39;gitea&#39;;
flush privileges;
quit;
</code></pre></div><footer class=post-footer><ul class=post-tags><li><a href=https://rengchi.github.io/tags/%E7%8E%AF%E5%A2%83/>ç¯å¢ƒ</a></li><li><a href=https://rengchi.github.io/tags/linux/>Linux</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://rengchi.github.io/>ä»è¿Ÿ</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>